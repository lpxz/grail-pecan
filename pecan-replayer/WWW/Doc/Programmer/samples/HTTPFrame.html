<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0//EN"
                      "http://www.w3.org/TR/REC-html40/strict.dtd">
<html>
  <head>
    <title>HTTPFrame.java</title>
    <meta name="Author" content="Benoit Mahe">
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <meta name="Generator" content="*emacs: emacs-css">

    <link rel="Stylesheet" media="screen" type="text/css" href="default-html.css">
  </head>
  <body>

    <pre>
<span class="comment">// HTTPFrame.java
// $Id: HTTPFrame.html,v 1.1 2011/07/26 02:22:37 smhuang Exp $
// (c) COPYRIGHT MIT and INRIA, 1997.
// Please first read the full copyright statement in file COPYRIGHT.html
</span>
<span class="keyword">package</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">jigsaw</span>.<span class="type">frames</span>;

<span class="keyword">import</span> <span class="reference">java</span>.<span class="reference">io</span>.*;
<span class="keyword">import</span> <span class="reference">java</span>.<span class="reference">net</span>.*;
<span class="keyword">import</span> <span class="reference">java</span>.<span class="reference">util</span>.*;

<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">codec</span>.*;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">sorter</span>.*;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">resources</span>.*;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">resources</span>.<span class="reference">event</span>.*;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">jigsaw</span>.<span class="reference">http</span>.* ;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">jigsaw</span>.<span class="reference">html</span>.* ;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">www</span>.<span class="reference">mime</span>.*;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">www</span>.<span class="reference">http</span>.*;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">crypt</span>.<span class="type">Md5</span>;

<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">resources</span>.<span class="type">ProtocolException</span>;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">resources</span>.<span class="type">NotAProtocolException</span>;

<span class="comment">/**
 * Default class to handle the HTTP protocol, manage FileResource and
 * DirectoryResource.
 */</span>
<span class="reference">public</span> <span class="keyword">class</span> <span class="function-name">HTTPFrame</span> <span class="keyword">extends</span> <span class="type">ProtocolFrame</span> {

    <span class="comment">/**
     * The special class of filter.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">Class</span> <span class="variable-name">filterClass</span> = <span class="keyword">null</span>;

    <span class="comment">/**
     * Condition check return code - Condition existed but failed.
     */</span>
    <span class="reference">public</span> <span class="type">static</span> <span class="type">final</span> <span class="type">int</span> <span class="variable-name">COND_FAILED</span> = 1;
    <span class="comment">/**
     * Condition check return code - Condition existed and succeeded.
     */</span>
    <span class="reference">public</span> <span class="type">static</span> <span class="type">final</span> <span class="type">int</span> <span class="variable-name">COND_OK</span> = 2;
  
    <span class="comment">// Methods allowed by that class in general:
</span>    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">HttpTokenList</span> <span class="variable-name">_allowed</span>        = <span class="keyword">null</span>;
    <span class="string">private</span>   <span class="type">static</span> <span class="type">HttpTokenList</span> <span class="variable-name">_put_allowed</span>    = <span class="keyword">null</span>;
    <span class="string">private</span>   <span class="type">static</span> <span class="type">HttpTokenList</span> <span class="variable-name">_browse_allowed</span> = <span class="keyword">null</span>;
    <span class="string">private</span>   <span class="type">static</span> <span class="type">HttpTokenList</span> <span class="variable-name">_accept_ranges</span>  = <span class="keyword">null</span>;

    <span class="type">static</span> {
	<span class="comment">// allowed shares _allowed value, that's a feature.
</span>	<span class="type">String</span> <span class="variable-name">str_allowed</span>[] = { "<span class="string">GET</span>", "<span class="string">HEAD</span>", "<span class="string">OPTIONS</span>", "<span class="string">TRACE</span>"};
	_allowed = HttpFactory.makeStringList(str_allowed);
	<span class="type">String</span> <span class="variable-name">str_allow</span>[] = { "<span class="string">HEAD</span>" , "<span class="string">GET</span>" , "<span class="string">PUT</span>" , "<span class="string">OPTIONS</span>", "<span class="string">TRACE</span>" };
	_put_allowed = HttpFactory.makeStringList(str_allow);
	<span class="type">String</span> <span class="variable-name">str_all</span>[] = { "<span class="string">HEAD</span>" , "<span class="string">GET</span>" , "<span class="string">BROWSE</span>" , "<span class="string">OPTIONS</span>","<span class="string">TRACE</span>" };
	_browse_allowed = HttpFactory.makeStringList(str_allow);
	<span class="type">String</span> <span class="variable-name">accept_ranges</span>[] = { "<span class="string">bytes</span>" };
	_accept_ranges = HttpFactory.makeStringList(accept_ranges);
    }
    <span class="comment">// Methods allowed by instances of that class in particular:
</span>    <span class="preprocessor">protected</span>        <span class="type">HttpTokenList</span>  <span class="variable-name">allowed</span> = _allowed;


    <span class="comment">/**
     * Attributes index - The index for the quality attribute.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_QUALITY</span> = -1 ;
    <span class="comment">/**
     * Attribute index - The index for the title attribute.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_TITLE</span> = -1 ;
    <span class="comment">/**
     * Attribute index - The index for the content languages attribute.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_CONTENT_LANGUAGE</span> = -1 ;
    <span class="comment">/**
     * Attribute index - The index for the content encodings attribute.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_CONTENT_ENCODING</span> = -1 ;
    <span class="comment">/**
     * Attribute index - The index for the content type attribute.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_CONTENT_TYPE</span> = -1 ;
    <span class="comment">/**
     * Attribute index - The index for the content length attribute.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_CONTENT_LENGTH</span> = -1 ;
    <span class="comment">/**
     * Attribute index - The icon (if any) associated to the resource.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_ICON</span> = -1 ;
    <span class="comment">/**
     * Attribute index - Max age: the maximum drift allowed from reality.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_MAXAGE</span> = -1 ;
    <span class="comment">/**
     * Attribute index - Send MD5 Digest: the md5 digest of the resource sent
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_MD5</span> = -1;


    <span class="comment">//
</span>    <span class="comment">// Attribute relative to FileResource
</span>    <span class="comment">//
</span>
    <span class="comment">/**
     * Attribute index - Do we allow PUT method on this file.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_PUTABLE</span> = -1 ;

    <span class="comment">//
</span>    <span class="comment">// Attribute relative to DirectoryResource
</span>    <span class="comment">//
</span>
    <span class="comment">/**
     * Attribute index - The index for our relocate attribute.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_RELOCATE</span> = -1 ;
    <span class="comment">/**
     * Attribute index - our index resource name.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_INDEX</span> = -1 ;
    <span class="comment">/**
     * Attribute index - The icon directory to use in dir listing.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_ICONDIR</span> = -1 ;
    <span class="comment">/**
     * Attribute index - Allow the GNN browse method.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_BROWSABLE</span> = -1 ;
    <span class="comment">/**
     * Attribute index - Style sheet for directory listing
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_STYLE_LINK</span> = -1 ;

    <span class="type">static</span> {
	<span class="type">Attribute</span> <span class="variable-name">a</span>   = <span class="keyword">null</span> ;
	<span class="type">Class</span>     <span class="variable-name">cls</span> = <span class="keyword">null</span> ;

	<span class="keyword">try</span> {
	    filterClass = 
		Class.forName("<span class="string">org.w3c.tools.resources.ResourceFilter</span>");
	} <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">ex</span>) {
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RuntimeException</span>("<span class="string">No ResourceFilter class found.</span>");
	}

	<span class="comment">// Get a pointer to our class:
</span>	<span class="keyword">try</span> {
	    cls = Class.forName("<span class="string">org.w3c.jigsaw.frames.HTTPFrame</span>") ;
	} <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">ex</span>) {
	    ex.printStackTrace() ;
	    System.exit(1) ;
	}
	<span class="comment">// The quality attribute:
</span>	a = <span class="keyword">new</span> <span class="type">DoubleAttribute</span>("<span class="string">quality</span>"
				, <span class="keyword">new</span> <span class="type">Double</span>(1.0) 
				, Attribute.EDITABLE);
	ATTR_QUALITY = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// The title attribute:
</span>	a = <span class="keyword">new</span> <span class="type">StringAttribute</span>("<span class="string">title</span>"
				, <span class="keyword">null</span>
				, Attribute.EDITABLE) ;
	ATTR_TITLE = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// The content language attribute:
</span>	a = <span class="keyword">new</span> <span class="type">LanguageAttribute</span>("<span class="string">content-language</span>"
				  , <span class="keyword">null</span>
				  , Attribute.EDITABLE) ;
	ATTR_CONTENT_LANGUAGE = AttributeRegistry.registerAttribute(cls,a);
	<span class="comment">// The content encoding attribute:
</span>	a = <span class="keyword">new</span> <span class="type">EncodingAttribute</span>("<span class="string">content-encoding</span>"
				  , <span class="keyword">null</span>
				  , Attribute.EDITABLE) ;
	ATTR_CONTENT_ENCODING = AttributeRegistry.registerAttribute(cls,a);
	<span class="comment">// The content type attribute:
</span>	a = <span class="keyword">new</span> <span class="type">MimeTypeAttribute</span>("<span class="string">content-type</span>"
				  , <span class="reference">MimeType</span>.<span class="type">TEXT_PLAIN</span>
				  , Attribute.EDITABLE) ;
	ATTR_CONTENT_TYPE = AttributeRegistry.registerAttribute(cls,a);
	<span class="comment">// The content length attribute:
</span>	a = <span class="keyword">new</span> <span class="type">IntegerAttribute</span>("<span class="string">content-length</span>"
				 , <span class="keyword">null</span>
				 , Attribute.COMPUTED);
	ATTR_CONTENT_LENGTH = AttributeRegistry.registerAttribute(cls,a);
	<span class="comment">// The icon attribute:
</span>	a = <span class="keyword">new</span> <span class="type">StringAttribute</span>("<span class="string">icon</span>"
				, <span class="keyword">null</span>
				, Attribute.EDITABLE) ;
	ATTR_ICON = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// The max age attribute (in ms)
</span>	a = <span class="keyword">new</span> <span class="type">LongAttribute</span>("<span class="string">maxage</span>"
			      , <span class="keyword">null</span>
			      , Attribute.EDITABLE) ;
	ATTR_MAXAGE = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// Should we send MD5 digest?
</span>	a = <span class="keyword">new</span> <span class="type">BooleanAttribute</span>("<span class="string">send-md5</span>"
				 , <span class="reference">Boolean</span>.<span class="type">FALSE</span>
				 , Attribute.EDITABLE);
	ATTR_MD5 = AttributeRegistry.registerAttribute(cls, a) ;

	<span class="comment">//
</span>	<span class="comment">// Attribute relative to a FileResource
</span>	<span class="comment">//
</span>
	<span class="comment">// The putable flag:
</span>	a = <span class="keyword">new</span> <span class="type">BooleanAttribute</span>("<span class="string">putable</span>"
				 , <span class="reference">Boolean</span>.<span class="type">FALSE</span>
				 , Attribute.EDITABLE) ;
	ATTR_PUTABLE = AttributeRegistry.registerAttribute(cls, a) ;

	<span class="comment">//
</span>	<span class="comment">// Attribute relative to a DirectoryResource
</span>	<span class="comment">//
</span>
	<span class="comment">//Should we relocate invalid request to this directory ?
</span>	a = <span class="keyword">new</span> <span class="type">BooleanAttribute</span>("<span class="string">relocate</span>"
				 , <span class="reference">Boolean</span>.<span class="type">TRUE</span>
				 , Attribute.EDITABLE);
	ATTR_RELOCATE = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// Our index resource name (optional).
</span>	a = <span class="keyword">new</span> <span class="type">StringAttribute</span>("<span class="string">index</span>"
				, <span class="keyword">null</span>
				, Attribute.EDITABLE) ;
	ATTR_INDEX = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// Our icon directory.
</span>	a = <span class="keyword">new</span> <span class="type">StringAttribute</span>("<span class="string">icondir</span>"
				, <span class="keyword">null</span>
				, Attribute.EDITABLE) ;
	ATTR_ICONDIR = AttributeRegistry.registerAttribute(cls,a);
	<span class="comment">// The browsable flag:
</span>	a = <span class="keyword">new</span> <span class="type">BooleanAttribute</span>("<span class="string">browsable</span>"
				 , <span class="reference">Boolean</span>.<span class="type">FALSE</span>
				 , Attribute.EDITABLE) ;
	ATTR_BROWSABLE = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// The style sheet attribute:
</span>	a = <span class="keyword">new</span> <span class="type">StringAttribute</span>("<span class="string">style-sheet-link</span>"
				, <span class="keyword">null</span>
				, Attribute.EDITABLE) ;
	ATTR_STYLE_LINK = AttributeRegistry.registerAttribute(cls, a) ;
    }

    <span class="preprocessor">protected</span> <span class="type">DirectoryResource</span> <span class="variable-name">dresource</span> = <span class="keyword">null</span>;
    <span class="preprocessor">protected</span> <span class="type">FileResource</span>      <span class="variable-name">fresource</span> = <span class="keyword">null</span>;

    <span class="reference">public</span> <span class="type">void</span> <span class="function-name">registerResource</span>(<span class="type">FramedResource</span> <span class="variable-name">resource</span>) {
	<span class="reference">super</span>.registerResource(resource);
	<span class="keyword">if</span> (resource <span class="keyword">instanceof</span> <span class="type">FileResource</span>)
	    fresource = (<span class="type">FileResource</span>) resource;
	<span class="keyword">else</span> <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> <span class="type">DirectoryResource</span>)
	    dresource = (<span class="type">DirectoryResource</span>) resource;
    }

    <span class="reference">public</span> <span class="type">FileResource</span> <span class="function-name">getFileResource</span>() {
	<span class="keyword">return</span> fresource;
    }

    <span class="reference">public</span> <span class="type">DirectoryResource</span> <span class="function-name">getDirectoryResource</span>() {
	<span class="keyword">return</span> dresource;
    }

    <span class="comment">/**
     * use this one instead of registerResource if the resource type 
     * doesn't matter or if this is not a file or a directory resource.
     * In subclasses you should have to do that:
     * &lt;pre&gt;
     *  public void registerResource(FramedResource resource) {
     *   super.registerOtherResource(resource);
     *  }
     * &lt;/pre&gt;
     * </span><span class="keyword">@param </span><span class="variable-name">the</span><span class="comment"> resource to register.
     */</span>
    <span class="reference">public</span> <span class="type">void</span> <span class="function-name">registerOtherResource</span>(<span class="type">FramedResource</span> <span class="variable-name">resource</span>) {
	<span class="reference">super</span>.registerResource(resource);
	dresource = <span class="keyword">null</span>;
	fresource = <span class="keyword">null</span>;
    }

    <span class="comment">// The HTTPResource keeps a cache of ready to use Http values. This 
</span>    <span class="comment">// allows to save converting to/from wire rep these objects. Not 
</span>    <span class="comment">// much CPU time, but also memory is spared.
</span>    <span class="type">HttpMimeType</span>  <span class="variable-name">contenttype</span>     = <span class="keyword">null</span>;
    <span class="type">HttpInteger</span>   <span class="variable-name">contentlength</span>   = <span class="keyword">null</span>;
    <span class="type">HttpDate</span>      <span class="variable-name">lastmodified</span>    = <span class="keyword">null</span>;
    <span class="type">HttpTokenList</span> <span class="variable-name">contentencoding</span> = <span class="keyword">null</span>;
    <span class="type">HttpTokenList</span> <span class="variable-name">contentlanguage</span> = <span class="keyword">null</span>;

    <span class="comment">// The Http entity tag for this resource (for FileResource only)
</span>    <span class="type">HttpEntityTag</span> <span class="variable-name">etag</span>   = <span class="keyword">null</span>;
    <span class="comment">// the MD5 digest for this resource (for FileResource only)
</span>    <span class="type">HttpString</span> <span class="variable-name">md5Digest</span> = <span class="keyword">null</span>;

    <span class="comment">/**
     * Get this resource's help url.
     * </span><span class="keyword">@return </span><span class="comment">An URL, encoded as a String, or &lt;strong&gt;null&lt;/strong&gt; if not
     * available.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getHelpURL</span>() {
	httpd server = (httpd) getServer();
	<span class="keyword">if</span> ( server == <span class="keyword">null</span> ) 
	    <span class="keyword">return</span> <span class="keyword">null</span>;
	<span class="type">String</span> <span class="variable-name">docurl</span> = server.getDocumentationURL();
	<span class="keyword">if</span> ( docurl == <span class="keyword">null</span> )
	    <span class="keyword">return</span> <span class="keyword">null</span>;
	<span class="keyword">return</span> docurl + "<span class="string">/</span>" + getClass().getName() + "<span class="string">.html</span>";
    }

    <span class="comment">/**
     * Get the help URL for that resource's attribute.
     * </span><span class="keyword">@param </span><span class="variable-name">topic</span><span class="comment"> The topic (can be an attribute name, or a property, etc).
     * </span><span class="keyword">@return </span><span class="comment">A String encoded URL, or &lt;strong&gt;null&lt;/strong&gt;.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getHelpURL</span>(<span class="type">String</span> <span class="variable-name">topic</span>) {
	httpd server = (httpd) getServer();
	<span class="keyword">if</span> ( server == <span class="keyword">null</span> ) 
	    <span class="keyword">return</span> <span class="keyword">null</span>;
	<span class="type">String</span> <span class="variable-name">docurl</span> = server.getDocumentationURL();
	<span class="keyword">if</span> ( docurl == <span class="keyword">null</span> )
	    <span class="keyword">return</span> <span class="keyword">null</span>;
	<span class="type">Class</span> <span class="variable-name">defines</span> = AttributeRegistry.getAttributeClass(getClass(), topic);
	<span class="keyword">if</span> ( defines != <span class="keyword">null</span> ) 
	    <span class="keyword">return</span> docurl + "<span class="string">/</span>" + defines.getName() + "<span class="string">.html</span>";
	<span class="keyword">return</span> <span class="keyword">null</span>;
    }

    <span class="comment">/** 
     * give the md5 digest from cache or calculate it
     * </span><span class="keyword">@return </span><span class="comment">the HttpString version of the digest
     */</span>

    <span class="string">private</span> <span class="type">HttpString</span> <span class="function-name">getMd5Digest</span>() {
	<span class="keyword">if</span> (md5Digest != <span class="keyword">null</span>)
	    <span class="keyword">return</span> md5Digest;
	<span class="comment">// not found, compute it if necessary!
</span>	<span class="type">Resource</span> <span class="variable-name">r</span> = getResource();
	<span class="keyword">if</span> (r <span class="keyword">instanceof</span> <span class="type">FileResource</span>) {
	    <span class="keyword">try</span> {
		<span class="type">Md5</span> <span class="variable-name">md5</span> = <span class="keyword">new</span> <span class="type">Md5</span> (
		    <span class="keyword">new</span> <span class="type">FileInputStream</span>(((<span class="type">FileResource</span>)r).getFile()));
		<span class="type">String</span> <span class="variable-name">s</span> = <span class="keyword">null</span>;
		<span class="keyword">try</span> {
		    <span class="type">byte</span> <span class="variable-name">b</span>[] = md5.getDigest();
		    <span class="type">Base64Encoder</span> <span class="variable-name">b64</span>;
		    <span class="type">ByteArrayOutputStream</span> <span class="variable-name">bos</span> = <span class="keyword">new</span> <span class="type">ByteArrayOutputStream</span>();
		    b64 = <span class="keyword">new</span> <span class="type">Base64Encoder</span>(<span class="keyword">new</span> <span class="type">ByteArrayInputStream</span>(b), bos);
		    b64.process();
		    s = bos.toString();
		    md5Digest = HttpFactory.makeString(s);
		} <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">mdex</span>) {
		    <span class="comment">// error, set it to null
</span>		    md5Digest = <span class="keyword">null</span>;
		}
		<span class="keyword">return</span> md5Digest;
	    } <span class="keyword">catch</span> (<span class="type">FileNotFoundException</span> <span class="variable-name">ex</span>) {
		<span class="comment">// silent fail
</span>		md5Digest = <span class="keyword">null</span>;
	    }
	}
	<span class="keyword">return</span> <span class="keyword">null</span>;
    }
    
    <span class="comment">/**
     * Listen its resource.
     */</span>
    <span class="reference">public</span> <span class="type">void</span> <span class="function-name">attributeChanged</span>(<span class="type">AttributeChangedEvent</span> <span class="variable-name">evt</span>) {
	<span class="reference">super</span>.attributeChanged(evt);
	<span class="type">String</span> <span class="variable-name">name</span> = evt.getAttribute().getName();
	<span class="keyword">if</span> (name.equals("<span class="string">file-stamp</span>")) {
	    etag = <span class="keyword">null</span>;
	    lastmodified = <span class="keyword">null</span>;
	    md5Digest = <span class="keyword">null</span>;
	} <span class="keyword">else</span> <span class="keyword">if</span> (name.equals("<span class="string">file-length</span>")) {
	    setValue(ATTR_CONTENT_LENGTH, evt.getNewValue());
	} <span class="keyword">else</span> <span class="keyword">if</span> (name.equals("<span class="string">last-modified</span>")) {
	    setValue(ATTR_LAST_MODIFIED, evt.getNewValue());
	} <span class="keyword">else</span> {
	    lastmodified = <span class="keyword">null</span>;
	}
    }

    <span class="comment">/**
     * Catch setValue, to maintain cached header values correctness.
     * </span><span class="keyword">@param </span><span class="variable-name">idx</span><span class="comment"> The index of the attribute to be set.
     * </span><span class="keyword">@param </span><span class="variable-name">value</span><span class="comment"> The new value for the attribute.
     */</span>

    <span class="reference">public</span> <span class="type">synchronized</span> <span class="type">void</span> <span class="function-name">setValue</span>(<span class="type">int</span> <span class="variable-name">idx</span>, <span class="type">Object</span> <span class="variable-name">value</span>) {
	<span class="reference">super</span>.setValue(idx, value);
	<span class="keyword">if</span> (idx == ATTR_CONTENT_TYPE)
	    contenttype = <span class="keyword">null</span>;
	<span class="keyword">if</span> (idx == ATTR_CONTENT_LENGTH)
	    contentlength = <span class="keyword">null</span>;
	<span class="keyword">if</span> ( idx == ATTR_CONTENT_ENCODING )
	    contentencoding = <span class="keyword">null</span>;
	<span class="keyword">if</span> ( idx == ATTR_CONTENT_LANGUAGE )
	    contentlanguage = <span class="keyword">null</span>;
	<span class="keyword">if</span> ( idx == ATTR_PUTABLE) {
	    <span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
		<span class="keyword">if</span> (value == Boolean.TRUE)
		    allowed = _put_allowed;
		<span class="keyword">else</span>
		    allowed = _allowed;
	    }
	}
	<span class="keyword">if</span> (idx == ATTR_MD5) {
	    md5Digest = <span class="keyword">null</span>; <span class="comment">// reset the digest state
</span>	}
	<span class="comment">// Any attribute setting modifies the last modified time:
</span>	lastmodified = <span class="keyword">null</span>;
    }

    <span class="comment">/**
     * Get the full URL for that resource.
     * </span><span class="keyword">@return </span><span class="comment">An URL instance.
     */</span>
    <span class="reference">public</span> <span class="type">URL</span> <span class="function-name">getURL</span>(<span class="type">Request</span> <span class="variable-name">request</span>) {
	<span class="keyword">try</span> {
	    <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">URL</span>(request.getURL(), resource.getURLPath());
	} <span class="keyword">catch</span> (<span class="type">MalformedURLException</span> <span class="variable-name">ex</span>) {
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RuntimeException</span>("<span class="string">unable to build </span>"+
				       getURLPath()+
				       "<span class="string"> full URL, from server </span>"+
				       getServer().getURL());
	}
    }

    <span class="comment">/**
     * Get this resource quality.
     * </span><span class="keyword">@return </span><span class="comment">The resource quality, or some negative value if not defined.
     */</span>

    <span class="reference">public</span> <span class="type">double</span> <span class="function-name">getQuality</span>() {
	<span class="keyword">return</span> getDouble(ATTR_QUALITY, -1.0) ;
    }

    <span class="comment">/**
     * Get this resource title.
     * </span><span class="keyword">@return </span><span class="comment">This resource's title, or &lt;strong&gt;null&lt;/strong&gt; if not 
     *    defined.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getTitle</span>() {
	<span class="keyword">return</span> getString(ATTR_TITLE, <span class="keyword">null</span>) ;
    }

    <span class="comment">/**
     * Get this resource content language.
     * Language are stored as a comma separated String of tokens.
     * </span><span class="keyword">@return </span><span class="comment">A comma separated string of language tokens, or
     *    &lt;strong&gt;null&lt;/strong&gt; if undefined.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getContentLanguage</span>() {
	<span class="keyword">return</span> (<span class="type">String</span>) getValue(ATTR_CONTENT_LANGUAGE, <span class="keyword">null</span>) ;
    } 

    <span class="comment">/**
     * Get this resource content encoding.
     * The content encoding of a resource is stored as a comma separated
     * list of tokens (as decribed in the Content_encoding header of the
     * HTTP specification, and in the order they should appear in the header).
     * </span><span class="keyword">@return </span><span class="comment">A string of comma separated encoding tokens, or
     *    &lt;strong&gt;null&lt;/strong&gt; if not defined.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getContentEncoding</span>() {
	<span class="type">String</span> <span class="variable-name">def</span> = (<span class="type">String</span>) attributes[ATTR_CONTENT_ENCODING].getDefault();
	System.out.println("<span class="string">Default [</span>"+def+"<span class="string">]</span>");
	<span class="type">String</span> <span class="variable-name">s</span> =  (<span class="type">String</span>) getString (ATTR_CONTENT_ENCODING, def) ;
	System.out.println("<span class="string">Defaulted to [</span>"+s+"<span class="string">]</span>");

	<span class="keyword">return</span> (<span class="type">String</span>) getString (ATTR_CONTENT_ENCODING, def) ;
    }

    <span class="comment">/**
     * Get this resource content type.
     * </span><span class="keyword">@return </span><span class="comment">An instance of MIMEType, or &lt;strong&gt;null&lt;/strong&gt; if not
     *    defined.
     */</span>

    <span class="reference">public</span> <span class="type">MimeType</span> <span class="function-name">getContentType</span>() {
	<span class="keyword">return</span> (<span class="type">MimeType</span>) getValue(ATTR_CONTENT_TYPE, <span class="keyword">null</span>);
    }

    <span class="comment">/**
     * Get this resource content length.
     * </span><span class="keyword">@return </span><span class="comment">The resource content length, or &lt;strong&gt;-1&lt;/strong&gt; if not
     *    defined.
     */</span>

    <span class="reference">public</span> <span class="type">int</span> <span class="function-name">getContentLength</span>() {
	<span class="keyword">return</span> getInt(ATTR_CONTENT_LENGTH, -1) ;
    }

    <span class="comment">/**
     * Get this resource's icon.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getIcon</span>() {
	<span class="keyword">return</span> getString(ATTR_ICON, <span class="keyword">null</span>) ;
    }

    <span class="comment">/**
     * Get this resource's max age.
     * The max age of a resource indicates how much drift is allowed between
     * the physicall version of the resource, and any in-memory cached version
     * of it.
     * &lt;p&gt;The max age attribute is a long number giving the number of 
     * milliseconds of allowed drift.
     */</span>

    <span class="reference">public</span> <span class="type">long</span> <span class="function-name">getMaxAge</span>() {
	<span class="keyword">return</span> getLong(ATTR_MAXAGE, (<span class="type">long</span>) -1) ;
    }

    <span class="comment">//
</span>    <span class="comment">// Relative to FileResource ...
</span>    <span class="comment">//
</span>
    <span class="comment">/**
     * Does this resource support byte ranges.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">boolean</span> <span class="variable-name">acceptRanges</span> = <span class="keyword">false</span>;

    <span class="comment">/**
     * Get the PUT'able flag (are we allow to PUT to the resource ?)
     */</span>
    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">getPutableFlag</span>() {
	<span class="keyword">return</span> getBoolean(ATTR_PUTABLE, <span class="keyword">false</span>) ;
    }

    <span class="comment">/**
     * Do we send the MD5 digest?
     */</span>
    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">getMD5Flag</span>() {
	<span class="keyword">return</span> getBoolean(ATTR_MD5, <span class="keyword">false</span>) ;
    }

    <span class="comment">/**
     * handles a Range Request
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment">, the request
     * </span><span class="keyword">@param </span><span class="variable-name">r</span><span class="comment">, the HttpRange
     * </span><span class="keyword">@return </span><span class="comment">a Reply if range is valid, or null if there is a change in the
     * resource, or if the HttpRange is not valid ( 4-2, for example).
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">handleRangeRequest</span>(<span class="type">Request</span> <span class="variable-name">request</span>, <span class="type">HttpRange</span> <span class="variable-name">r</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="comment">// Should we check against a IfRange header ?
</span>	<span class="type">HttpEntityTag</span> <span class="variable-name">t</span> = request.getIfRange();

	<span class="keyword">if</span> ( t != <span class="keyword">null</span> ) {
	    <span class="keyword">if</span> (t.isWeak() || ! t.getTag().equals(etag.getTag()))
		<span class="keyword">return</span> <span class="keyword">null</span>;
	}
	<span class="comment">// Check the range:
</span>	<span class="type">int</span> <span class="variable-name">cl</span> = getContentLength();
	<span class="type">int</span> <span class="variable-name">fb</span> = r.getFirstPosition();
	<span class="type">int</span> <span class="variable-name">lb</span> = r.getLastPosition();
	<span class="type">int</span> <span class="variable-name">sz</span>;

	<span class="keyword">if</span> (fb > cl-1) { <span class="comment">// first byte already out of range
</span>	    <span class="type">HttpContentRange</span> <span class="variable-name">cr</span> = HttpFactory.makeContentRange("<span class="string">bytes</span>", 0,
							       cl - 1, cl);
	    <span class="type">Reply</span> <span class="variable-name">rr</span>;
	    rr = createDefaultReply(request, 
				    HTTP.REQUESTED_RANGE_NOT_SATISFIABLE);
	    rr.setContentLength(-1);
	    rr.setHeaderValue(rr.H_CONTENT_RANGE, cr);
	    <span class="keyword">if</span> (getMD5Flag()) 
		rr.setContentMD5(<span class="keyword">null</span>);
	    <span class="keyword">return</span> rr;
	}

	<span class="keyword">if</span> ((fb < 0) && (lb >= 0)) { <span class="comment">// ex: bytes=-20 final 20 bytes
</span>	    <span class="keyword">if</span> (lb >= cl)   <span class="comment">// cut the end
</span>		lb = cl;
	    sz = lb;
	    fb = cl - lb;
	    lb = cl - 1;
	} <span class="keyword">else</span> <span class="keyword">if</span> (lb < 0) {  <span class="comment">// ex: bytes=10- the last size - 10
</span>	    lb = cl-1;
	    sz = lb-fb+1;
	} <span class="keyword">else</span> {              <span class="comment">// ex: bytes=10-20
</span>	    <span class="keyword">if</span> (lb >= cl)  <span class="comment">// cut the end
</span>		lb = cl-1;
	    sz = lb-fb+1;
	}
	<span class="keyword">if</span> ((fb < 0) || (lb < 0) || (fb <= lb)) {
	    <span class="type">HttpContentRange</span> <span class="variable-name">cr</span> = <span class="keyword">null</span>;
	    fb = (fb < 0) ? 0 : fb;
	    lb = ((lb > cl) || (lb < 0)) ? cl : lb;
	    cr = HttpFactory.makeContentRange("<span class="string">bytes</span>", fb, lb, cl);
	    <span class="comment">// Emit reply:
</span>	    <span class="type">Reply</span> <span class="variable-name">rr</span> = createDefaultReply(request, HTTP.PARTIAL_CONTENT);
	    <span class="comment">// FIXME check for MD5 of only the subpart
</span>	    <span class="keyword">try</span> { <span class="comment">// create the MD5 for the subpart
</span>		<span class="keyword">if</span> (getMD5Flag()) {
		    <span class="type">String</span> <span class="variable-name">s</span> = <span class="keyword">null</span>;
		    <span class="keyword">try</span> {
			<span class="type">ByteRangeOutputStream</span> <span class="variable-name">br</span>;
			br = <span class="keyword">new</span> <span class="type">ByteRangeOutputStream</span>(fresource.getFile(),
						       fb, lb+1);
			<span class="type">Md5</span> <span class="variable-name">md5</span> = <span class="keyword">new</span> <span class="type">Md5</span> (br);
			<span class="type">byte</span> <span class="variable-name">b</span>[] = md5.getDigest();
			<span class="type">Base64Encoder</span> <span class="variable-name">b64</span>;
			<span class="type">ByteArrayOutputStream</span> <span class="variable-name">bs</span> = <span class="keyword">new</span> <span class="type">ByteArrayOutputStream</span>();
			b64 = <span class="keyword">new</span> <span class="type">Base64Encoder</span>(<span class="keyword">new</span> <span class="type">ByteArrayInputStream</span>(b),
						bs);
			b64.process();
			s = bs.toString();
		    } <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">md_ex</span>) {
			<span class="comment">// default to null, no action here then
</span>		    }
		    <span class="keyword">if</span> (s == <span class="keyword">null</span>)
			rr.setContentMD5(<span class="keyword">null</span>); 
		    <span class="keyword">else</span> 
			rr.setContentMD5(s);
		}
      		rr.setContentLength(sz);
		rr.setHeaderValue(rr.H_CONTENT_RANGE, cr);
		rr.setStream(<span class="keyword">new</span> <span class="type">ByteRangeOutputStream</span>(fresource.getFile(),
						       fb,
						       lb+1));
		<span class="keyword">return</span> rr;
	    } <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {
	    }
	} 
	<span class="keyword">return</span> <span class="keyword">null</span>;
    }

    <span class="comment">//
</span>    <span class="comment">// Relative to DirectoryResource ...
</span>    <span class="comment">//
</span>
    <span class="comment">/**
     * Get this class browsable flag.
     */</span>
    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">getBrowsableFlag</span>() {
	<span class="keyword">return</span> getBoolean (ATTR_BROWSABLE, <span class="keyword">false</span>) ;
    }

    <span class="comment">/**
     * Get this frame style sheet link
     */</span>
    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getStyleSheetURL</span>() {
	<span class="keyword">return</span> getString (ATTR_STYLE_LINK, <span class="keyword">null</span>);
    }

    <span class="comment">/**
     * Our current (cached) directory listing.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">HtmlGenerator</span> <span class="variable-name">listing</span> = <span class="keyword">null</span> ;
    <span class="comment">/**
     * The time at which we generated the directory index.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">long</span> <span class="variable-name">listing_stamp</span> = -1 ;

    <span class="string">private</span> <span class="type">String</span> <span class="function-name">getUnextendedName</span>(<span class="type">String</span> <span class="variable-name">name</span>) {
	<span class="type">int</span> <span class="variable-name">strlen</span> = name.length() ;
	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < strlen ; i++) {
	    <span class="comment">// FIXME: Should use the system props to get the right sep
</span>	    <span class="keyword">if</span> ( name.charAt(i) == '<span class="string">.</span>' ) {
		<span class="keyword">if</span> ( i == 0 )
		    <span class="keyword">return</span> <span class="keyword">null</span> ;
		<span class="keyword">return</span> name.substring(0, i) ;
	    }
	}
	<span class="keyword">return</span> <span class="keyword">null</span> ;
    }

    <span class="comment">/**
     * Get the optional icon directory.
     */</span>
    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getIconDirectory</span>() { 
	<span class="keyword">return</span> getString(ATTR_ICONDIR, "<span class="string">/icons</span>") ;
    }



    <span class="comment">/**
     * Should we relocate invalid requests to this directory.
     * </span><span class="keyword">@return </span><span class="comment">A boolean &lt;strong&gt;true&lt;/strong&gt; if we should relocate.
     */</span>
    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">getRelocateFlag</span>() {
	<span class="keyword">return</span> getBoolean(ATTR_RELOCATE, <span class="keyword">true</span>) ;
    }

    <span class="comment">/**
     * Get the optinal index name for this directory listing.
     * </span><span class="keyword">@return </span><span class="comment">The name of the resource responsible to list that container.
     */</span>
    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getIndex</span>() {
	<span class="keyword">return</span> (<span class="type">String</span>) getValue(ATTR_INDEX, <span class="keyword">null</span>) ;
    }

    <span class="comment">/**
     * Add our own Style Sheet to the HtmlGenerator.
     * </span><span class="keyword">@param </span><span class="variable-name">g</span><span class="comment"> The HtmlGenerator.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">void</span> <span class="function-name">addStyleSheet</span>(<span class="type">HtmlGenerator</span> <span class="variable-name">g</span>) {
	<span class="comment">// Add style link
</span>	<span class="type">String</span> <span class="variable-name">css_url</span> = getStyleSheetURL();
	<span class="keyword">if</span> (css_url != <span class="keyword">null</span>) {
	    g.addLink( <span class="keyword">new</span> <span class="type">HtmlLink</span>("<span class="string">STYLESHEET</span>", 
				    css_url, 
				    MimeType.TEXT_CSS));
	}
    }

    <span class="comment">/**
     * Reply with an HTML doc listing the resources of this directory.
     * This function takes special care not to regenerate a directory listing
     * when one is available. It also caches the date of the directory 
     * listing, so that it can win big with NOT_MODIFIED.
     * &lt;p&gt;Using a modem, I know that each place I can reply with an 
     * NOT_MODIFIED, &lt;strong&gt;is&lt;/strong&gt; a big win.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> If processsing the request failed.
     */</span>

    <span class="reference">public</span> <span class="type">synchronized</span> <span class="type">Reply</span> <span class="function-name">getDirectoryListing</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="keyword">if</span> (dresource == <span class="keyword">null</span>) 
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NotAProtocolException</span>("<span class="string">this frame is not attached to a </span>"+
					    "<span class="string">DirectoryResource. (</span>"+
					    resource.getIdentifier()+"<span class="string">)</span>");
	<span class="comment">// delete us if the directory was deleted
</span>	<span class="keyword">if</span> (! dresource.getDirectory().exists()) {
	    <span class="comment">//delete us and emit an error
</span>	    <span class="type">String</span> <span class="variable-name">msg</span> = dresource.getIdentifier()+
		"<span class="string">: deleted, removing the DirectoryResource</span>";
	    getServer().errlog(dresource, msg);
	    <span class="keyword">try</span> {
		dresource.delete();
	    } <span class="keyword">catch</span> (<span class="type">MultipleLockException</span> <span class="variable-name">ex</span>) {
	    }
	    <span class="comment">// Emit an error back:
</span>	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_FOUND) ;
	    error.setContent ("<span class="string">&lt;h1&gt;Document not found&lt;/h1&gt;</span>"+
			      "<span class="string">&lt;p&gt;The document </span>"+
			      request.getURL()+
			      "<span class="string"> is indexed but not available.</span>"+
			      "<span class="string">&lt;p&gt;The server is misconfigured.</span>") ;
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	}
	<span class="comment">// Have we already an up-to-date computed a listing ?
</span>	<span class="keyword">if</span> ((listing == <span class="keyword">null</span>) 
	    || (dresource.getDirectory().lastModified() > listing_stamp)
	    || (dresource.getLastModified() > listing_stamp)
	    || (getLastModified() > listing_stamp)) {
      
	    <span class="type">Class</span> <span class="variable-name">http_class</span> = <span class="keyword">null</span>;
	    <span class="keyword">try</span> {
		http_class = Class.forName("<span class="string">org.w3c.jigsaw.frames.HTTPFrame</span>");
	    } <span class="keyword">catch</span> (<span class="type">ClassNotFoundException</span> <span class="variable-name">ex</span>) {
		http_class = <span class="keyword">null</span>;
	    }

	    <span class="type">Enumeration</span>   <span class="variable-name">enum</span>      = 
		dresource.enumerateResourceIdentifiers() ;
	    <span class="type">Vector</span>        <span class="variable-name">resources</span> = Sorter.sortStringEnumeration(enum) ;
	    <span class="type">HtmlGenerator</span> <span class="variable-name">g</span>         = 
		<span class="keyword">new</span> <span class="type">HtmlGenerator</span>("<span class="string">Directory of </span>"+
				  dresource.getIdentifier());
	    <span class="comment">// Add style link
</span>	    addStyleSheet(g);
	    g.append("<span class="string">&lt;h1&gt;</span>"+dresource.getIdentifier()+"<span class="string">&lt;/h1&gt;</span>");
	    <span class="comment">// Link to the parent, when possible:
</span>	    <span class="keyword">if</span> ( dresource.getParent() != <span class="keyword">null</span> )
		g.append("<span class="string">&lt;p&gt;&lt;a href=\"..\"&gt;Parent&lt;/a&gt;&lt;br&gt;</span>");
	    <span class="comment">// List the children:
</span>	    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < resources.size() ; i++) {
		<span class="type">String</span>       <span class="variable-name">name</span>     = (<span class="type">String</span>) resources.elementAt(i);
		<span class="type">ResourceReference</span> <span class="variable-name">rr</span> = <span class="keyword">null</span>;
		rr = dresource.lookup(name);
		<span class="type">FramedResource</span> <span class="variable-name">resource</span> = <span class="keyword">null</span>;
		<span class="keyword">if</span> (rr != <span class="keyword">null</span>) {
		    <span class="keyword">try</span> {
			resource = (<span class="type">FramedResource</span>) rr.lock();
			<span class="type">HTTPFrame</span> <span class="variable-name">itsframe</span> = <span class="keyword">null</span>;
			<span class="keyword">if</span> (http_class != <span class="keyword">null</span>)
			    itsframe = 
				(<span class="type">HTTPFrame</span>) resource.getFrame(http_class);
			<span class="keyword">if</span> (itsframe != <span class="keyword">null</span>) {
			    <span class="comment">// Icon first, if available
</span>			    <span class="type">String</span> <span class="variable-name">icon</span> = itsframe.getIcon() ;
			    <span class="keyword">if</span> ( icon != <span class="keyword">null</span> ) 
				g.append("<span class="string">&lt;img src=\"</span>"+
					 getIconDirectory() +"<span class="string">/</span>" + icon+
					 "<span class="string">\"&gt;</span>");
			    <span class="comment">// Resource's name with link:
</span>			    g.append("<span class="string">&lt;a href=\"</span>" 
				     , resource.getURLPath()
				     , "<span class="string">\"&gt;</span>"+name+"<span class="string">&lt;/a&gt;</span>");
			    <span class="comment">// resource's title, if any:
</span>			    <span class="type">String</span> <span class="variable-name">title</span> = itsframe.getTitle();
			    <span class="keyword">if</span> ( title != <span class="keyword">null</span> )
				g.append("<span class="string"> </span>"+title);
			    g.append("<span class="string">&lt;br&gt;</span>");
			} <span class="keyword">else</span> {
			    <span class="comment">// Resource's name with link:
</span>			    g.append(name+"<span class="string"> (&lt;i&gt;Not available via HTTP.&lt;/i&gt;)</span>");
			    g.append("<span class="string">&lt;br&gt;</span>");
			}
		    } <span class="keyword">catch</span> (<span class="type">InvalidResourceException</span> <span class="variable-name">ex</span>) {
			g.append(name+
				 "<span class="string"> cannot be loaded (server misconfigured)</span>");
			g.append("<span class="string">&lt;br&gt;</span>");
			<span class="keyword">continue</span>;
		    } <span class="keyword">finally</span> { 
			rr.unlock();
		    }
		}
	    }
	    g.close() ;
	    listing_stamp = getLastModified() ;
	    listing       = g ;
	} <span class="keyword">else</span> <span class="keyword">if</span> ( checkIfModifiedSince(request) == COND_FAILED ) {
	    <span class="comment">// Is it an IMS request ?
</span>	    <span class="type">Reply</span> <span class="variable-name">reply</span> = createDefaultReply(request, HTTP.NOT_MODIFIED) ;
	    reply.setContentMD5(<span class="keyword">null</span>);
	    <span class="keyword">return</span> reply;
	}
	<span class="comment">// New content or need update:
</span>	<span class="type">Reply</span> <span class="variable-name">reply</span> = createDefaultReply(request, HTTP.OK) ;
	reply.setLastModified(listing_stamp) ;
	reply.setStream(listing) ;
	<span class="comment">// check MD5
</span>	<span class="keyword">return</span> reply ;
    }

    <span class="comment">//
</span>    <span class="comment">// Commom part.
</span>    <span class="comment">//
</span>


    <span class="comment">/**
     * Update the cached headers value.
     * Each resource maintains a set of cached values for headers, this
     * allows for a nice sped-up in headers marshalling, which - as the 
     * complexity of the protocol increases - becomes a bottleneck.
     */</span>

    <span class="preprocessor">protected</span> <span class="type">void</span> <span class="function-name">updateCachedHeaders</span>() {
	<span class="comment">// Precompute a set of header values to keep by:
</span>	<span class="keyword">if</span> ( contenttype == <span class="keyword">null</span> )
	    contenttype = HttpFactory.makeMimeType(getContentType());
	<span class="keyword">if</span> (contentlength == <span class="keyword">null</span>) {
	    <span class="type">int</span> <span class="variable-name">cl</span> = -1;
	    <span class="keyword">if</span> (fresource != <span class="keyword">null</span>) 
		cl = fresource.getFileLength();
	    <span class="keyword">if</span> ( cl >= 0 ) {
		setValue(ATTR_CONTENT_LENGTH, <span class="keyword">new</span> <span class="type">Integer</span>(cl));
		contentlength = HttpFactory.makeInteger(cl);
	    }
	}
	<span class="keyword">if</span> ( lastmodified == <span class="keyword">null</span> ) {
	    <span class="type">long</span> <span class="variable-name">lm</span> = getLastModified();
	    <span class="keyword">if</span> ( lm > 0 )
		lastmodified = HttpFactory.makeDate(getLastModified());
	}
	<span class="keyword">if</span> (definesAttribute(ATTR_CONTENT_ENCODING) &&(contentencoding==<span class="keyword">null</span>))
	    contentencoding = HttpFactory.makeStringList(getContentEncoding());
	<span class="keyword">if</span> (definesAttribute(ATTR_CONTENT_LANGUAGE) &&(contentlanguage==<span class="keyword">null</span>))
	    contentlanguage = HttpFactory.makeStringList(getContentLanguage());

	<span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="comment">// We only take car eof etag here:
</span>	    <span class="keyword">if</span> ( etag == <span class="keyword">null</span> ) {
		<span class="type">long</span> <span class="variable-name">lstamp</span> = fresource.getFileStamp();
		<span class="keyword">if</span> ( lstamp >= 0L ) {
		    <span class="type">String</span> <span class="variable-name">soid</span>  = Integer.toString(getOid(), 32);
		    <span class="type">String</span> <span class="variable-name">stamp</span> = Long.toString(lstamp, 32);
		    etag = HttpFactory.makeETag(<span class="keyword">false</span>, soid+"<span class="string">:</span>"+stamp);
		}
	    }
	    <span class="keyword">if</span> (getMD5Flag() && (md5Digest == <span class="keyword">null</span>)) {
		getMd5Digest();
	    }
	}
    }

    <span class="comment">/**
     * Create a reply to answer to request on this file.
     * This method will create a suitable reply (matching the given request)
     * and will set all its default header values to the appropriate 
     * values.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to make a reply for.
     * </span><span class="keyword">@return </span><span class="comment">An instance of Reply, suited to answer this request.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">createDefaultReply</span>(<span class="type">Request</span> <span class="variable-name">request</span>, <span class="type">int</span> <span class="variable-name">status</span>) {
	<span class="type">Reply</span> <span class="variable-name">reply</span> = request.makeReply(status);
	updateCachedHeaders();
	<span class="keyword">if</span> ( status != HTTP.NOT_MODIFIED ) {
	    <span class="keyword">if</span> ( contentlength != <span class="keyword">null</span> )
		reply.setHeaderValue(Reply.H_CONTENT_LENGTH, contentlength);
	    <span class="keyword">if</span> ( contenttype != <span class="keyword">null</span> )
		reply.setHeaderValue(Reply.H_CONTENT_TYPE, contenttype);
	    <span class="keyword">if</span> ( lastmodified != <span class="keyword">null</span> )
		reply.setHeaderValue(Reply.H_LAST_MODIFIED, lastmodified);
	    <span class="keyword">if</span> ( contentencoding != <span class="keyword">null</span> ) {
System.out.println("<span class="string">Content Encoding [</span>" + contentencoding +"<span class="string">]</span>");
		reply.setHeaderValue(Reply.H_CONTENT_ENCODING,contentencoding);
	    }
	    <span class="keyword">if</span> ( contentlanguage != <span class="keyword">null</span> )
		reply.setHeaderValue(Reply.H_CONTENT_LANGUAGE,contentlanguage);
      
	}
	<span class="type">long</span> <span class="variable-name">maxage</span> = getMaxAge();
	<span class="keyword">if</span> ( maxage >= 0 ) {
	    <span class="keyword">if</span> (reply.getMajorVersion() >= 1 ) {
		<span class="keyword">if</span> (reply.getMinorVersion() >= 1) {
		    reply.setMaxAge((<span class="type">int</span>) (maxage / 1000));
		} 
		<span class="comment">// If max-age is zero, say what you mean:
</span>		<span class="type">long</span> <span class="variable-name">expires</span> = (System.currentTimeMillis()
				+ ((maxage == 0) ? -1000 : maxage));
		reply.setExpires(expires);
	    }
	}
	<span class="comment">// Set the date of the reply (round it to secs):
</span>	reply.setDate((System.currentTimeMillis() / 1000L) * 1000L);
    
	<span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="comment">// Set the entity tag:
</span>	    <span class="keyword">if</span> ( etag != <span class="keyword">null</span> )
		reply.setHeaderValue(reply.H_ETAG, etag);
	    <span class="keyword">if</span> ( acceptRanges )
		reply.setHeaderValue(reply.H_ACCEPT_RANGES, _accept_ranges);
	    <span class="keyword">if</span> ( getMD5Flag()) {
		reply.setHeaderValue(reply.H_CONTENT_MD5, getMd5Digest());
	    }
	}

	<span class="keyword">return</span> reply;
    }

    <span class="comment">/**
     * Check the &lt;code&gt;If-Match&lt;/code&gt; condition of that request.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to check.
     * </span><span class="keyword">@return </span><span class="comment">An integer, either &lt;code&gt;COND_FAILED&lt;/cond&gt; if condition
     * was checked, but failed, &lt;code&gt;COND_OK&lt;/code&gt; if condition was checked
     * and succeeded, or &lt;strong&gt;0&lt;/strong&gt; if the condition was not checked
     * at all (eg because the resource or the request didn't support it).
     */</span>

    <span class="reference">public</span> <span class="type">int</span> <span class="function-name">checkIfMatch</span>(<span class="type">Request</span> <span class="variable-name">request</span>) {
	<span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="type">HttpEntityTag</span> <span class="variable-name">tags</span>[] = request.getIfMatch();
	    <span class="keyword">if</span> ( tags != <span class="keyword">null</span> ) {
		<span class="comment">// Good, real validators in use:
</span>		<span class="keyword">if</span> ( etag != <span class="keyword">null</span> ) {
		    <span class="comment">// Note: if etag is null this means that the resource has 
</span>		    <span class="comment">// changed and has not been even emited since then...
</span>		    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < tags.length ; i++) {
			<span class="type">HttpEntityTag</span> <span class="variable-name">t</span> = tags[i];
			<span class="keyword">if</span> ((!t.isWeak()) && t.getTag().equals(etag.getTag()))
			    <span class="keyword">return</span> COND_OK;
		    }
		}
		<span class="keyword">return</span> COND_FAILED;
	    }
	}
	<span class="keyword">return</span> 0;
    }

    <span class="comment">/**
     * Check the &lt;code&gt;If-None-Match&lt;/code&gt; condition of that request.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to check.
     * </span><span class="keyword">@return </span><span class="comment">An integer, either &lt;code&gt;COND_FAILED&lt;/cond&gt; if condition
     * was checked, but failed, &lt;code&gt;COND_OK&lt;/code&gt; if condition was checked
     * and succeeded, or &lt;strong&gt;0&lt;/strong&gt; if the condition was not checked
     * at all (eg because the resource or the request didn't support it).
     */</span>

    <span class="reference">public</span> <span class="type">int</span> <span class="function-name">checkIfNoneMatch</span>(<span class="type">Request</span> <span class="variable-name">request</span>) {
	<span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="comment">// Check for an If-None-Match conditional:
</span>	    <span class="type">HttpEntityTag</span> <span class="variable-name">tags</span>[] = request.getIfNoneMatch();
	    <span class="keyword">if</span> ( tags != <span class="keyword">null</span> ) {
		<span class="keyword">if</span> ( etag == <span class="keyword">null</span> )
		    <span class="keyword">return</span> COND_OK;
		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < tags.length ; i++) {
		    <span class="type">HttpEntityTag</span> <span class="variable-name">t</span> = tags[i];
		    <span class="keyword">if</span> (( ! t.isWeak()) && t.getTag().equals(etag.getTag()))
			<span class="keyword">return</span> COND_FAILED;
		}
		<span class="keyword">return</span> COND_OK;
	    }
	}
	<span class="keyword">return</span> 0;
    }

    <span class="comment">/**
     * Check the &lt;code&gt;If-Modified-Since&lt;/code&gt; condition of that request.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to check.
     * </span><span class="keyword">@return </span><span class="comment">An integer, either &lt;code&gt;COND_FAILED&lt;/cond&gt; if condition
     * was checked, but failed, &lt;code&gt;COND_OK&lt;/code&gt; if condition was checked
     * and succeeded, or &lt;strong&gt;0&lt;/strong&gt; if the condition was not checked
     * at all (eg because the resource or the request didn't support it).
     */</span>

    <span class="reference">public</span> <span class="type">int</span> <span class="function-name">checkIfModifiedSince</span>(<span class="type">Request</span> <span class="variable-name">request</span>) {
	<span class="comment">// Check for an If-Modified-Since conditional:
</span>	<span class="type">long</span> <span class="variable-name">ims</span> = request.getIfModifiedSince();
	<span class="keyword">if</span> (dresource != <span class="keyword">null</span>) {
	    <span class="keyword">if</span> (ims >= 0) 
		<span class="keyword">return</span> (((listing_stamp > 0) && (listing_stamp - 1000 <= ims))
			? <span class="type">COND_FAILED</span>
			: COND_OK);
	} <span class="keyword">else</span> <span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="type">long</span> <span class="variable-name">cmt</span> = getLastModified();
	    <span class="keyword">if</span> ( ims >= 0 )
		<span class="keyword">return</span> ((cmt > 0) && (cmt - 1000 <= ims)) 
		    ? COND_FAILED : COND_OK;
	}
	<span class="keyword">return</span> 0;
    }

    <span class="comment">/**
     * Check the &lt;code&gt;If-Unmodified-Since&lt;/code&gt; condition of that request.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to check.
     * </span><span class="keyword">@return </span><span class="comment">An integer, either &lt;code&gt;COND_FAILED&lt;/cond&gt; if condition
     * was checked, but failed, &lt;code&gt;COND_OK&lt;/code&gt; if condition was checked
     * and succeeded, or &lt;strong&gt;0&lt;/strong&gt; if the condition was not checked
     * at all (eg because the resource or the request didn't support it).
     */</span>

    <span class="reference">public</span> <span class="type">int</span> <span class="function-name">checkIfUnmodifiedSince</span>(<span class="type">Request</span> <span class="variable-name">request</span>) {
	<span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="comment">// Check for an If-Unmodified-Since conditional:
</span>	    <span class="type">long</span> <span class="variable-name">iums</span> = request.getIfUnmodifiedSince();
	    <span class="type">long</span> <span class="variable-name">cmt</span> = getLastModified();
	    <span class="keyword">if</span> ( iums >= 0 ) 
		<span class="keyword">return</span> ((cmt > 0) && (cmt - 1000) >= iums) 
		    ? COND_FAILED : COND_OK;
	}
	<span class="keyword">return</span> 0;
    }

    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">lookup</span>(<span class="type">LookupState</span> <span class="variable-name">ls</span>, <span class="type">LookupResult</span> <span class="variable-name">lr</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="type">RequestInterface</span> <span class="variable-name">req</span> = ls.getRequest(); 
	<span class="keyword">if</span> (! checkRequest(req)) 
	    <span class="keyword">return</span> <span class="keyword">false</span>;
	<span class="keyword">if</span> (lookupFilters(ls,lr))
	    <span class="keyword">return</span> <span class="keyword">true</span>;
	<span class="keyword">return</span> lookupResource(ls,lr);
    }

    <span class="preprocessor">protected</span> <span class="type">boolean</span> <span class="function-name">lookupResource</span>(<span class="type">LookupState</span> <span class="variable-name">ls</span>, <span class="type">LookupResult</span> <span class="variable-name">lr</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="keyword">return</span> lookupFile(ls,lr);
	} <span class="keyword">else</span> <span class="keyword">if</span> (dresource != <span class="keyword">null</span>) {
	    <span class="keyword">return</span> lookupDirectory(ls,lr);
	} <span class="keyword">else</span> {
	    <span class="keyword">return</span> lookupOther(ls,lr);
	}
    }

    <span class="preprocessor">protected</span> <span class="type">boolean</span> <span class="function-name">lookupFilters</span>(<span class="type">LookupState</span> <span class="variable-name">ls</span>, <span class="type">LookupResult</span> <span class="variable-name">lr</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="type">ResourceFilter</span> <span class="variable-name">filters</span>[] = getFilters();
	<span class="keyword">if</span> ( filters != <span class="keyword">null</span> ) {
	    <span class="comment">// Mark filters, for them to be called at outgoing time:
</span>	    lr.addFilters(filters);
	    <span class="comment">// Some clever filter around ?
</span>	    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < filters.length ; i++) {
		<span class="keyword">if</span> ( filters[i] == <span class="keyword">null</span> )
		    <span class="keyword">continue</span>;
		<span class="keyword">if</span> ( filters[i].lookup(ls, lr) )
		    <span class="keyword">return</span> <span class="keyword">true</span>;
	    }
	}
	<span class="keyword">return</span> <span class="keyword">false</span>;
    }

    <span class="preprocessor">protected</span> <span class="type">boolean</span> <span class="function-name">lookupDirectory</span>(<span class="type">LookupState</span> <span class="variable-name">ls</span>, <span class="type">LookupResult</span> <span class="variable-name">lr</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="comment">// Give a chance to our super-class to run its own lookup scheme:
</span>	<span class="comment">// do we have to create a resource (PUT) ?
</span>	<span class="keyword">if</span> ((ls.hasMoreComponents()) && getPutableFlag()) {
	    <span class="type">Request</span> <span class="variable-name">request</span> = (<span class="type">Request</span>) ls.getRequest() ;
	    <span class="keyword">if</span> ((request == <span class="keyword">null</span>) || request.getMethod().equals("<span class="string">PUT</span>")) {
		<span class="comment">// We might well want to create a resource:
</span>		<span class="type">String</span>            <span class="variable-name">name</span> = ls.peekNextComponent() ;
		<span class="type">ResourceReference</span> <span class="variable-name">rr</span>   = dresource.lookup(name);
		<span class="keyword">if</span> ((rr == <span class="keyword">null</span>) && (dresource.getExtensibleFlag())) {
		    <span class="keyword">if</span> (ls.countRemainingComponents() == 1)
			rr = dresource.createResource(name, request);
		    <span class="keyword">else</span>
			rr = dresource.createDirectoryResource(name);
		    <span class="keyword">if</span> (rr == <span class="keyword">null</span>) {
			<span class="type">Reply</span> <span class="variable-name">error</span> = 
			    request.makeReply(HTTP.UNSUPPORTED_MEDIA_TYPE);
			error.setContent(
			    "<span class="string">Failed to create resource </span>"+
			    name +"<span class="string"> : </span>"+
			    "<span class="string">Unable to create the appropriate file:</span>"+
			    request.getURLPath()+
			    "<span class="string"> this media type is not supported</span>");
			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error);
		    }
		} <span class="keyword">else</span> <span class="keyword">if</span> (rr == <span class="keyword">null</span>) {
		    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.FORBIDDEN) ;
		    error.setContent("<span class="string">You are not allowed to create resource </span>"+
				     name +"<span class="string"> : </span>"+
				     dresource.getIdentifier()+
				     "<span class="string"> is not extensible.</span>");
		    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error);
		}
	    }
	}
	<span class="keyword">if</span> ( <span class="reference">super</span>.lookup(ls, lr) ) {
	    <span class="keyword">if</span> ( ! ls.isDirectory() && ! ls.isInternal() ) {
		<span class="comment">// The directory lookup URL doesn't end with a slash:
</span>		<span class="type">Request</span> <span class="variable-name">request</span> = (<span class="type">Request</span>)ls.getRequest() ;
		<span class="keyword">if</span> ( request == <span class="keyword">null</span> ) {
		    lr.setTarget(<span class="keyword">null</span>);
		    <span class="keyword">return</span> <span class="keyword">true</span>;
		}
		<span class="type">URL</span> <span class="variable-name">url</span> = <span class="keyword">null</span>;
		<span class="keyword">try</span> {
		    url = (ls.hasRequest() 
			   ? getURL(request)
			   : <span class="keyword">new</span> <span class="type">URL</span>(getServer().getURL(), 
				     resource.getURLPath()));
		} <span class="keyword">catch</span> (<span class="type">MalformedURLException</span> <span class="variable-name">ex</span>) {
		    getServer().errlog(<span class="reference">this</span>, "<span class="string">unable to build full URL.</span>");
		    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span>("<span class="string">Internal server error</span>");
		}
		<span class="type">String</span> <span class="variable-name">msg</span> = "<span class="string">Invalid requested URL: the directory resource </span>"+
		    "<span class="string"> you are trying to reach is available only through </span>"+
		    "<span class="string"> its full URL: &lt;a href=\"</span>"+
		    url + "<span class="string">\"&gt;</span>" + url + "<span class="string">&lt;/a&gt;.</span>";
		<span class="keyword">if</span> ( getRelocateFlag() ) {
		    <span class="comment">// Emit an error (with reloc if allowed)
</span>		    <span class="type">Reply</span> <span class="variable-name">reloc</span> = request.makeReply(HTTP.FOUND);
		    reloc.setContent(msg) ;
		    reloc.setLocation(url);
		    lr.setTarget(<span class="keyword">null</span>);
		    lr.setReply(reloc);
		    <span class="keyword">return</span> <span class="keyword">true</span>;
		} <span class="keyword">else</span> {
		    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_FOUND) ;
		    error.setContent(msg) ;
		    lr.setTarget(<span class="keyword">null</span>);
		    lr.setReply(error);
		    <span class="keyword">return</span> <span class="keyword">true</span>;
		}
	    } <span class="keyword">else</span> <span class="keyword">if</span> ( ! ls.isInternal() ) {
		<span class="comment">// return the index file.
</span>		<span class="type">String</span> <span class="variable-name">index</span> = getIndex();
		<span class="keyword">if</span> ( index != <span class="keyword">null</span> && index.length() > 0) {
		    <span class="type">DirectoryResource</span> <span class="variable-name">dir</span> = (<span class="type">DirectoryResource</span>) resource;
		    <span class="type">ResourceReference</span> <span class="variable-name">rr</span> = dir.lookup(index);
		    <span class="keyword">if</span> (rr != <span class="keyword">null</span>) {
			<span class="keyword">try</span> {
			    <span class="type">FramedResource</span> <span class="variable-name">rindex</span> = (<span class="type">FramedResource</span>) rr.lock();
			    <span class="keyword">return</span> rindex.lookup(ls,lr);
			} <span class="keyword">catch</span> (<span class="type">InvalidResourceException</span> <span class="variable-name">ex</span>) {
			} <span class="keyword">finally</span> {
			    rr.unlock();
			}
		    }
		}
	    }
	    <span class="keyword">return</span> <span class="keyword">true</span>;
	}
	<span class="keyword">return</span> <span class="keyword">false</span>;
    }

    <span class="preprocessor">protected</span> <span class="type">boolean</span> <span class="function-name">lookupFile</span>(<span class="type">LookupState</span> <span class="variable-name">ls</span>, <span class="type">LookupResult</span> <span class="variable-name">lr</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="keyword">return</span> <span class="reference">super</span>.lookup(ls,lr);
    }

    <span class="preprocessor">protected</span> <span class="type">boolean</span> <span class="function-name">lookupOther</span>(<span class="type">LookupState</span> <span class="variable-name">ls</span>, <span class="type">LookupResult</span> <span class="variable-name">lr</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="keyword">return</span> <span class="reference">super</span>.lookup(ls,lr);
    }

    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">checkRequest</span>(<span class="type">RequestInterface</span> <span class="variable-name">request</span>) {
	<span class="keyword">return</span> ((request == <span class="keyword">null</span>) 
		? <span class="keyword">true</span> 
		:(request <span class="keyword">instanceof</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">jigsaw</span>.<span class="reference">http</span>.<span class="type">Request</span>));
    }

    <span class="preprocessor">protected</span> <span class="type">ReplyInterface</span> <span class="function-name">performFrames</span>(<span class="type">RequestInterface</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="keyword">return</span> <span class="reference">super</span>.performFrames(request);
    }

    <span class="reference">public</span> <span class="type">ReplyInterface</span> <span class="function-name">perform</span>(<span class="type">RequestInterface</span> <span class="variable-name">req</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">ReplyInterface</span> <span class="variable-name">repi</span> = <span class="reference">super</span>.perform(req);
	<span class="keyword">if</span> (repi != <span class="keyword">null</span>)
	    <span class="keyword">return</span> repi;

	<span class="keyword">if</span> (! checkRequest(req))
	    <span class="keyword">return</span> <span class="keyword">null</span>;

	<span class="type">Reply</span>  <span class="variable-name">reply</span>  = <span class="keyword">null</span>;
	<span class="type">Request</span> <span class="variable-name">request</span> = (<span class="type">Request</span>) req;
	<span class="type">String</span> <span class="variable-name">method</span> = request.getMethod () ;
	<span class="comment">// Perform the request:
</span>	<span class="keyword">if</span> ( method.equals("<span class="string">GET</span>") ) {
	    reply = get(request) ;
	} <span class="keyword">else</span> <span class="keyword">if</span> ( method.equals("<span class="string">HEAD</span>") ) {
	    reply = head(request) ;
	} <span class="keyword">else</span> <span class="keyword">if</span> ( method.equals("<span class="string">POST</span>") ) {
	    reply = post(request) ;
	} <span class="keyword">else</span> <span class="keyword">if</span> ( method.equals("<span class="string">PUT</span>") ) {
	    reply = put(request) ;
	} <span class="keyword">else</span> <span class="keyword">if</span> ( method.equals("<span class="string">OPTIONS</span>") ) {
	    reply = options(request);
	} <span class="keyword">else</span> <span class="keyword">if</span> ( method.equals("<span class="string">DELETE</span>") ) {
	    reply = delete(request) ;
	} <span class="keyword">else</span> <span class="keyword">if</span> ( method.equals("<span class="string">LINK</span>") ) {
	    reply = link(request) ;
	} <span class="keyword">else</span> <span class="keyword">if</span> ( method.equals("<span class="string">UNLINK</span>") ) {
	    reply = unlink(request) ;
	} <span class="keyword">else</span> <span class="keyword">if</span> ( method.equals("<span class="string">TRACE</span>") ) {
	    reply = trace(request) ;
	} <span class="keyword">else</span> {
	    reply = extended(request) ;
	}
	<span class="keyword">return</span> reply;
    }

    <span class="comment">/**
     * The default GET method.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> if processing the request failed.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">get</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="keyword">if</span> (dresource != <span class="keyword">null</span>) {
	    <span class="comment">// we manage a DirectoryResource
</span>	    <span class="keyword">return</span> getDirectoryResource(request) ;
	} <span class="keyword">else</span> <span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="comment">// we manage a FileResource
</span>	    <span class="keyword">return</span> getFileResource(request);
	} <span class="keyword">else</span> {
	    <span class="keyword">return</span> getOtherResource(request);
	}
    }

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">getOtherResource</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="comment">// we don't manage this kind of resource
</span>	<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_IMPLEMENTED) ;
	error.setContent("<span class="string">Method GET not implemented.</span>") ;
	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
    }

    <span class="comment">/**
     * Create the reply relative to the given file.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> the incomming request.
     * </span><span class="keyword">@return </span><span class="comment">A Reply instance
     */</span>
    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">createFileReply</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">File</span> <span class="variable-name">file</span> = fresource.getFile() ;
	<span class="type">Reply</span> <span class="variable-name">reply</span> = <span class="keyword">null</span>;
	<span class="comment">// Check for a range request:
</span>	<span class="type">HttpRange</span> <span class="variable-name">ranges</span>[] = request.getRange();
	<span class="keyword">if</span> ((ranges != <span class="keyword">null</span>) && (ranges.length == 1)) {
	    <span class="type">Reply</span> <span class="variable-name">rangereply</span> = handleRangeRequest(request, ranges[0]);
	    <span class="keyword">if</span> ( rangereply != <span class="keyword">null</span> )
		<span class="keyword">return</span> rangereply;
	}
	<span class="comment">// Default to full reply:
</span>	reply = createDefaultReply(request, HTTP.OK) ;
	<span class="keyword">try</span> { 
	    reply.setStream(<span class="keyword">new</span> <span class="type">FileInputStream</span>(file));
	} <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {
	    <span class="comment">// I hate to have to loose time in tries
</span>	}
	<span class="keyword">return</span> reply ;
    }

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">getFileResource</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="keyword">if</span> (fresource == <span class="keyword">null</span>) 
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NotAProtocolException</span>("<span class="string">this frame is not attached to a </span>"+
					    "<span class="string">FileResource. (</span>"+
					    resource.getIdentifier()+"<span class="string">)</span>");
	<span class="type">Reply</span> <span class="variable-name">reply</span> = <span class="keyword">null</span>;
	<span class="type">File</span> <span class="variable-name">file</span> = fresource.getFile() ;
	fresource.checkContent();
	updateCachedHeaders();
	<span class="comment">// Check validators:
</span>	<span class="keyword">if</span> ( checkIfMatch(request) == COND_FAILED ) {
	    reply = request.makeReply(HTTP.PRECONDITION_FAILED);
	    reply.setContent("<span class="string">Pre-conditions failed.</span>");
	    reply.setContentMD5(<span class="keyword">null</span>);
	    <span class="keyword">return</span> reply;
	}
	<span class="keyword">if</span> ( checkIfNoneMatch(request) == COND_FAILED ) {
	    reply = createDefaultReply(request, HTTP.NOT_MODIFIED);
	    reply.setContentMD5(<span class="keyword">null</span>);
	    <span class="keyword">return</span> reply;
	}
	<span class="keyword">if</span> ( checkIfModifiedSince(request) == COND_FAILED ) {
	    reply = createDefaultReply(request, HTTP.NOT_MODIFIED);
	    reply.setContentMD5(<span class="keyword">null</span>);
	    <span class="keyword">return</span> reply;
	}
	<span class="keyword">if</span> ( checkIfUnmodifiedSince(request) == COND_FAILED ) {
	    reply = request.makeReply(HTTP.PRECONDITION_FAILED);
	    reply.setContent("<span class="string">Pre-conditions failed.</span>");
	    reply.setContentMD5(<span class="keyword">null</span>);
	    <span class="keyword">return</span> reply;
	}
	<span class="comment">// Does this file really exists, if so send it back
</span>	<span class="keyword">if</span> ( file.exists() ) {
	    <span class="keyword">return</span> createFileReply(request);
	} <span class="keyword">else</span> {
	    <span class="comment">// Delete the resource if parent is extensible:
</span>	    <span class="type">boolean</span> <span class="variable-name">extensible</span> = <span class="keyword">false</span>;
	    <span class="type">ResourceReference</span> <span class="variable-name">rr</span> = fresource.getParent();
	    <span class="type">ResourceReference</span> <span class="variable-name">rrtemp</span> = <span class="keyword">null</span>;
	    <span class="type">Resource</span> <span class="variable-name">p</span> = <span class="keyword">null</span>;
	    <span class="keyword">while</span> ( <span class="keyword">true</span> ) {
		<span class="keyword">try</span> {
		    <span class="keyword">if</span> (rr == <span class="keyword">null</span>)
			<span class="keyword">break</span>;
		    p = rr.lock();
		    <span class="keyword">if</span> (p <span class="keyword">instanceof</span> <span class="type">DirectoryResource</span>) {
			extensible = 
			    ((<span class="type">DirectoryResource</span>)p).getExtensibleFlag();
			<span class="keyword">break</span>;
		    }
		    rrtemp = p.getParent();
		} <span class="keyword">catch</span> (<span class="type">InvalidResourceException</span> <span class="variable-name">ex</span>) {
		    <span class="keyword">break</span>;
		} <span class="keyword">finally</span> {
		    <span class="keyword">if</span> (rr != <span class="keyword">null</span>)
			rr.unlock();
		}
		rr = rrtemp;
	    }
	    <span class="keyword">if</span> (extensible) {
		<span class="comment">// The resource is indexed but has no file, emit an error
</span>		<span class="type">String</span> <span class="variable-name">msg</span> = fresource.getFile()+
		    "<span class="string">: deleted, removing the FileResource.</span>";
		getServer().errlog(fresource, msg);
		<span class="keyword">try</span> {
		    fresource.delete();
		} <span class="keyword">catch</span> (<span class="type">MultipleLockException</span> <span class="variable-name">ex</span>) {
		    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_FOUND) ;
		    error.setContentMD5(<span class="keyword">null</span>); <span class="comment">// FIXME must compute it!
</span>		    error.setContent ("<span class="string">&lt;h1&gt;Document not found&lt;/h1&gt;</span>"+
				      "<span class="string">&lt;p&gt;The document </span>"+
				      request.getURL()+
				      "<span class="string"> is indexed but not available.</span>"+
				      "<span class="string">&lt;p&gt;</span>"+ex.getMessage()+
				      "<span class="string">&lt;p&gt;The server is misconfigured.</span>") ;
		    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
		}
	    }
	    <span class="comment">// Emit an error back:
</span>	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_FOUND) ;
	    error.setContentMD5(<span class="keyword">null</span>);
	    error.setContent ("<span class="string">&lt;h1&gt;Document not found&lt;/h1&gt;</span>"+
			      "<span class="string">&lt;p&gt;The document </span>"+
			      request.getURL()+
			      "<span class="string"> is indexed but not available.</span>"+
			      "<span class="string">&lt;p&gt;The server is misconfigured.</span>") ;
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	}
    }

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">getDirectoryResource</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="keyword">return</span> getDirectoryListing(request) ;
    }

    <span class="comment">/**
     * The default HEAD method replies does a GET and removes entity.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> Always thrown, to return a NOT_IMPLEMENTED
     *    error.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">head</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="keyword">if</span> (dresource != <span class="keyword">null</span>) {
	    <span class="keyword">return</span> headDirectoryResource(request);
	} <span class="keyword">else</span> <span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="keyword">return</span> headFileResource(request);
	} <span class="keyword">else</span> {
	    <span class="keyword">return</span> headOtherResource(request);
	}
    }

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">headOtherResource</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">reply</span> = <span class="keyword">null</span>;
	reply = getOtherResource(request) ;
	reply.setStream((<span class="type">InputStream</span>) <span class="keyword">null</span>);
	<span class="keyword">return</span> reply;
    }

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">headDirectoryResource</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">reply</span> = <span class="keyword">null</span>;
	reply = getDirectoryResource(request) ;
	reply.setStream((<span class="type">InputStream</span>) <span class="keyword">null</span>);
	<span class="keyword">return</span> reply;
    }

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">headFileResource</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="keyword">if</span> (fresource == <span class="keyword">null</span>) 
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NotAProtocolException</span>("<span class="string">this frame is not attached to a </span>"+
					    "<span class="string">FileResource. (</span>"+
					    resource.getIdentifier()+"<span class="string">)</span>");
	<span class="type">Reply</span> <span class="variable-name">reply</span> = <span class="keyword">null</span>;
	fresource.checkContent();
	updateCachedHeaders();
	<span class="comment">// Conditional check:
</span>	<span class="keyword">if</span> ( checkIfMatch(request) == COND_FAILED ) {
	    <span class="type">Reply</span> <span class="variable-name">r</span> = request.makeReply(HTTP.PRECONDITION_FAILED);
	    r.setContent("<span class="string">Pre-conditions failed.</span>");
	    <span class="keyword">return</span> r;
	}
	<span class="keyword">if</span> ( checkIfNoneMatch(request) == COND_FAILED )
	    <span class="keyword">return</span> createDefaultReply(request, HTTP.NOT_MODIFIED);
	<span class="keyword">if</span> ( checkIfModifiedSince(request) == COND_FAILED )
	    <span class="keyword">return</span> createDefaultReply(request, HTTP.NOT_MODIFIED);
	<span class="keyword">if</span> ( checkIfUnmodifiedSince(request) == COND_FAILED ) {
	    <span class="type">Reply</span> <span class="variable-name">r</span> = request.makeReply(HTTP.PRECONDITION_FAILED);
	    r.setContent("<span class="string">Pre-conditions failed.</span>");
	    <span class="keyword">return</span> r;
	}
	<span class="keyword">if</span> (! fresource.getFile().exists()) {
	    <span class="comment">// Delete the resource if parent is extensible:
</span>	    <span class="type">boolean</span> <span class="variable-name">extensible</span> = <span class="keyword">false</span>;
	    <span class="type">ResourceReference</span> <span class="variable-name">rr</span> = fresource.getParent();
	    <span class="type">ResourceReference</span> <span class="variable-name">rrtemp</span> = <span class="keyword">null</span>;
	    <span class="type">Resource</span> <span class="variable-name">p</span> = <span class="keyword">null</span>;
	    <span class="keyword">while</span> ( <span class="keyword">true</span> ) {
		<span class="keyword">try</span> {
		    <span class="keyword">if</span> (rr == <span class="keyword">null</span>)
			<span class="keyword">break</span>;
		    p = rr.lock();
		    <span class="keyword">if</span> (p <span class="keyword">instanceof</span> <span class="type">DirectoryResource</span>)
			extensible = 
			    ((<span class="type">DirectoryResource</span>)p).getExtensibleFlag();
		    rrtemp = p.getParent();
		} <span class="keyword">catch</span> (<span class="type">InvalidResourceException</span> <span class="variable-name">ex</span>) {
		    <span class="keyword">break</span>;
		} <span class="keyword">finally</span> {
		    <span class="keyword">if</span> (rr != <span class="keyword">null</span>)
			rr.unlock();
		}
		rr = rrtemp;
	    }
	    <span class="keyword">if</span> (extensible) {
		<span class="comment">// The resource is indexed but has no file, emit an error
</span>		<span class="type">String</span> <span class="variable-name">msg</span> = fresource.getFile()+
		    "<span class="string">: deleted, removing the FileResource.</span>";
		getServer().errlog(fresource, msg);
		<span class="keyword">try</span> {
		    fresource.delete();
		} <span class="keyword">catch</span> (<span class="type">MultipleLockException</span> <span class="variable-name">ex</span>) {
		    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_FOUND) ;
		    error.setContent ("<span class="string">&lt;h1&gt;Document not found&lt;/h1&gt;</span>"+
				      "<span class="string">&lt;p&gt;The document </span>"+
				      request.getURL()+
				      "<span class="string"> is indexed but not available.</span>"+
				      "<span class="string">&lt;p&gt;</span>"+ex.getMessage()+
				      "<span class="string">&lt;p&gt;The server is misconfigured.</span>") ;
		    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
		}
	    }
	    <span class="comment">// Emit an error back:
</span>	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_FOUND) ;
	    error.setContent ("<span class="string">&lt;h1&gt;Document not found&lt;/h1&gt;</span>"+
			      "<span class="string">&lt;p&gt;The document </span>"+
			      request.getURL()+
			      "<span class="string"> is indexed but not available.</span>"+
			      "<span class="string">&lt;p&gt;The server is misconfigured.</span>") ;
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	}
	<span class="keyword">return</span> createDefaultReply(request, HTTP.OK);
    }

    <span class="comment">/**
     * The default POST method replies with a not implemented.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> Always thrown, to return a NOT_IMPLEMENTED
     *    error.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">post</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_ALLOWED) ;
	<span class="keyword">if</span> ( allowed != <span class="keyword">null</span> )
	    error.setHeaderValue(Reply.H_ALLOW, allowed);
	error.setContent("<span class="string">Method POST not allowed on this resource.</span>") ;
	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
    }

    <span class="comment">/**
     * The default PUT method replies with a not implemented.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> Always thrown, to return a NOT_IMPLEMENTED
     *    error.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">put</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="keyword">if</span> (fresource != <span class="keyword">null</span>) {
	    <span class="keyword">return</span> putFileResource(request);
	} <span class="keyword">else</span> {
	    <span class="keyword">return</span> putOtherResource(request);
	}
    }

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">putOtherResource</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_IMPLEMENTED) ;
	error.setContent("<span class="string">Method PUT not implemented.</span>") ;
	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
    }

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">putFileResource</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">reply</span> = <span class="keyword">null</span>;
	<span class="type">int</span> <span class="variable-name">status</span> = HTTP.OK;
	fresource.checkContent();
	updateCachedHeaders();
	<span class="comment">// Is this resource writable ?
</span>	<span class="keyword">if</span> ( ! getPutableFlag() ) {
	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_ALLOWED) ;
	    error.setContent("<span class="string">Method PUT not allowed.</span>") ;
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	}
	<span class="comment">// Check validators:
</span>	<span class="keyword">if</span> ((checkIfMatch(request) == COND_FAILED)
	    || (checkIfNoneMatch(request) == COND_FAILED)
	    || (checkIfModifiedSince(request) == COND_FAILED)
	    || (checkIfUnmodifiedSince(request) == COND_FAILED)) {
	    <span class="type">Reply</span> <span class="variable-name">r</span> = request.makeReply(HTTP.PRECONDITION_FAILED);
	    r.setContent("<span class="string">Pre-condition failed.</span>");
	    <span class="keyword">return</span> r;
	}
	<span class="comment">// Check the request:
</span>	<span class="type">InputStream</span> <span class="variable-name">in</span> = <span class="keyword">null</span>;
	<span class="keyword">try</span> {
	    in = request.getInputStream();
	    <span class="keyword">if</span> ( in == <span class="keyword">null</span> ) {
		<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.BAD_REQUEST) ;
		error.setContent ("<span class="string">&lt;p&gt;Request doesn't have a valid content.</span>");
		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	    }
	} <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ClientException</span>(request.getClient(), ex);
	}
	<span class="comment">// We do not support (for the time being) put with ranges:
</span>	<span class="keyword">if</span> ( request.hasContentRange() ) {
	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.BAD_REQUEST);
	    error.setContent("<span class="string">partial PUT not supported.</span>");
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span>(error);
	}
	<span class="comment">// Check that if some type is provided it doesn't conflict:
</span>	<span class="keyword">if</span> ( request.hasContentType() ) {
	    <span class="type">MimeType</span> <span class="variable-name">rtype</span> = request.getContentType() ;
	    <span class="type">MimeType</span> <span class="variable-name">type</span>  = getContentType() ;
	    <span class="keyword">if</span> ( type == <span class="keyword">null</span> ) {
		setValue (ATTR_CONTENT_TYPE, rtype) ;
	    } <span class="keyword">else</span> <span class="keyword">if</span> ( rtype.match (type) < 0 ) {
		<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.UNSUPPORTED_MEDIA_TYPE) ;
		error.setContent ("<span class="string">&lt;p&gt;Invalid content type: </span>"+type.toString());
		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	    }
	}
	<span class="comment">// Write the body back to the file:
</span>	<span class="keyword">try</span> {
	    <span class="comment">// We are about to accept the put, notify client before continuing
</span>	    <span class="type">Client</span> <span class="variable-name">client</span> = request.getClient();
	    <span class="keyword">if</span> ( client != <span class="keyword">null</span>  && request.getExpect() != <span class="keyword">null</span> ) {
		client.sendContinue();
	    }
	    <span class="keyword">if</span> ( fresource.newContent(request.getInputStream()) )
		status = HTTP.CREATED;
	    <span class="keyword">else</span>
		status = HTTP.NO_CONTENT;
	} <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ClientException</span>(request.getClient(), ex);
	}
	<span class="keyword">if</span> ( status == HTTP.CREATED ) {
	    reply = request.makeReply(status);
	    reply.setLocation(getURL(request));
	    reply.setContent ("<span class="string">&lt;p&gt;Entity body saved succesfully !</span>") ;
	} <span class="keyword">else</span> {
	    reply = createDefaultReply(request, status);
	}
	<span class="keyword">return</span> reply ;
    }

    <span class="comment">/**
     * The default OPTIONS method replies with a not implemented.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> In case of errors.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">options</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">reply</span> = createDefaultReply(request, HTTP.OK);
	<span class="comment">// Removed unused headers:
</span>	reply.setContentLength(-1);
	reply.setContentType(<span class="keyword">null</span>);
	<span class="comment">// Add the allow header:
</span>	<span class="keyword">if</span> ( allowed != <span class="keyword">null</span> )
	    reply.setHeaderValue(Reply.H_ALLOW, allowed);
	<span class="keyword">return</span> reply;
    }

    <span class="comment">/**
     * The default DELETE method replies with a not implemented.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> Always thrown, to return a NOT_IMPLEMENTED
     *    error.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">delete</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_IMPLEMENTED) ;
	error.setContent("<span class="string">Method DELETE not implemented.</span>") ;
	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
    }

    <span class="comment">/**
     * The default LINK method replies with a not implemented.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> Always thrown, to return a NOT_IMPLEMENTED
     *    error.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">link</span>(<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_IMPLEMENTED) ;
	error.setContent("<span class="string">Method LINK not implemented.</span>") ;
	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
    }

    <span class="comment">/**
     * The default UNLINK method replies with a not implemented.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> Always thrown, to return a NOT_IMPLEMENTED
     *    error.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">unlink</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_IMPLEMENTED) ;
	error.setContent("<span class="string">Method UNLINK not implemented.</span>") ;
	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
    }

    <span class="comment">/**
     * The default TRACE method replies with a not implemented
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">HTTPException</span><span class="comment"> In case of errors.
     * </span><span class="keyword">@exception </span><span class="type">ClientException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">trace</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
        <span class="keyword">throws</span> <span class="type">HTTPException</span>, <span class="type">ClientException</span>
    {
        <span class="type">Reply</span> <span class="variable-name">reply</span> = createDefaultReply(request, HTTP.OK);
	reply.setNoCache(); <span class="comment">// don't cache this
</span>        reply.setMaxAge(-1); <span class="comment">// 
</span>	reply.setContentMD5(<span class="keyword">null</span>);
        <span class="comment">// Dump the request as the body
</span>        <span class="comment">// Removed unused headers:
</span>	<span class="comment">// FIXME should be something else for chuncked stream
</span>	<span class="type">ByteArrayOutputStream</span> <span class="variable-name">ba</span> = <span class="keyword">new</span> <span class="type">ByteArrayOutputStream</span>();
	<span class="keyword">try</span> {
	    reply.setContentType(<span class="keyword">new</span> <span class="type">MimeType</span>("<span class="string">message/http</span>"));
	    request.dump(ba);
	    reply.setContentLength(ba.size());
	} <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">ex</span>) {
	    ex.printStackTrace();
	}
	reply.setStream(<span class="keyword">new</span> <span class="type">ByteArrayInputStream</span>(ba.toByteArray()));
	<span class="keyword">return</span> reply;
    }
    
    <span class="comment">/**
     * The handler for unknown method replies with a not implemented.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> Always thrown, to return a NOT_IMPLEMENTED
     *    error.
     * </span><span class="keyword">@exception </span><span class="type">NotAProtocolException</span><span class="comment"> If the client instance controling the
     * request processing got a fatal error.
     */</span>

    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">extended</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">String</span> <span class="variable-name">method</span> = request.getMethod() ;
	<span class="keyword">if</span> ((method != <span class="keyword">null</span>) && method.equals("<span class="string">BROWSE</span>") && getBrowsableFlag())
	    <span class="keyword">return</span> browse(request) ;

	<span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_IMPLEMENTED) ;
	error.setContent("<span class="string">Method </span>"+method+"<span class="string"> not implemented.</span>") ;
	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
    }

    <span class="comment">/**
     * Handle the browse method.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     */</span>

    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">MimeType</span>  <span class="variable-name">browsetype</span> = <span class="keyword">null</span>;

    <span class="preprocessor">protected</span> <span class="type">synchronized</span> <span class="type">MimeType</span> <span class="function-name">getBrowseType</span>() {
	<span class="keyword">if</span> ( browsetype == <span class="keyword">null</span> ) {
	    <span class="keyword">try</span> {
		browsetype = <span class="keyword">new</span> <span class="type">MimeType</span>("<span class="string">application/x-navibrowse</span>");
	    } <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">ex</span>) {
		ex.printStackTrace();
	    }
	}
	<span class="keyword">return</span> browsetype;
    }

    <span class="comment">/**
     * A present to GNNPress users !
     * This method implements the &lt;code&gt;BROWSE&lt;/code&gt; method that
     * AOL press (or GNN press, or whatever its last name is) expects.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to process.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> If some error occurs.
     * </span><span class="keyword">@return </span><span class="comment">A Reply instance.
     */</span>
    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">browse</span> (<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="keyword">if</span> (dresource == <span class="keyword">null</span>) {
	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_IMPLEMENTED) ;
	    error.setContent("<span class="string">Method </span>"+request.getMethod()+
			     "<span class="string"> not implemented.</span>") ;
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	}

	<span class="type">Enumeration</span>  <span class="variable-name">enum</span>      = dresource.enumerateResourceIdentifiers() ;
	<span class="type">Vector</span>       <span class="variable-name">resources</span> = Sorter.sortStringEnumeration(enum) ;
	<span class="type">int</span>          <span class="variable-name">rsize</span>     = ((resources == <span class="keyword">null</span>) ? 0 : resources.size()) ;
	<span class="type">StringBuffer</span> <span class="variable-name">sb</span>        = <span class="keyword">new</span> <span class="type">StringBuffer</span>() ;

	<span class="comment">// As we have enumerated all resources, just looking the store is ok
</span>	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < rsize ; i++) {
	    <span class="type">String</span>            <span class="variable-name">rname</span> = (<span class="type">String</span>) resources.elementAt(i) ;
	    <span class="type">ResourceReference</span> <span class="variable-name">rr</span>    = <span class="keyword">null</span>;
	    <span class="type">Resource</span>          <span class="variable-name">r</span>     = <span class="keyword">null</span>;
	    <span class="keyword">try</span> {
		rr = dresource.lookup(rname) ;
		r = rr.lock();
		<span class="comment">// may throw InvalidResourceException
</span>
		<span class="keyword">if</span> ( r <span class="keyword">instanceof</span> <span class="type">DirectoryResource</span> ) {
		    sb.append("<span class="string">application/x-navidir </span>"+
			      rname+
			      "<span class="string">\r\n</span>") ;
		} <span class="keyword">else</span> {
		    <span class="type">HTTPFrame</span> <span class="variable-name">itsframe</span> = 
			(<span class="type">HTTPFrame</span>) resource.getFrame(getClass());
		    <span class="keyword">if</span> (itsframe != <span class="keyword">null</span>) {
			sb.append(itsframe.getContentType().toString()+
				  "<span class="string"> </span>"+
				  rname+
				  "<span class="string">\r\n</span>") ;
		    }
		}
	    } <span class="keyword">catch</span> (<span class="type">InvalidResourceException</span> <span class="variable-name">ex</span>) {
		<span class="keyword">continue</span>;
	    } <span class="keyword">finally</span> {
		rr.unlock();
	    }
	}
	<span class="type">Reply</span> <span class="variable-name">reply</span> = request.makeReply(HTTP.OK) ;
	reply.addPragma("<span class="string">no-cache</span>");
	reply.setNoCache();
	reply.setContent(sb.toString()) ;
	reply.setContentType(getBrowseType());
	<span class="keyword">return</span> reply ;
    }

    <span class="comment">//
</span>    <span class="comment">// Filtered part
</span>    <span class="comment">//
</span>
    <span class="comment">/**
     * Get our whole list of filters.
     */</span>
  
    <span class="reference">public</span> <span class="type">synchronized</span> <span class="type">ResourceFilter</span>[] <span class="function-name">getFilters</span>() {
	<span class="type">ResourceFrame</span> <span class="variable-name">frames</span>[] = collectFrames(filterClass);
	<span class="keyword">if</span> ( frames != <span class="keyword">null</span> ) {
	    <span class="comment">// FIXME Normally a simple cast should suffice (?)
</span>	    <span class="type">ResourceFilter</span> <span class="variable-name">f</span>[] = <span class="keyword">new</span> <span class="type">ResourceFilter</span>[frames.length];
	    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < frames.length ; i++)
		f[i] = (<span class="type">ResourceFilter</span>) frames[i];
	    <span class="keyword">return</span> f;
	}
	<span class="keyword">return</span> <span class="keyword">null</span>;
    }
    
    <span class="comment">/**
     * Get the list of filters of this class.
     * </span><span class="keyword">@param </span><span class="variable-name">cls</span><span class="comment"> The class of filters requested.
     * </span><span class="keyword">@return </span><span class="comment">An array of filters, which are instances of the given class.
     */</span>
  
    <span class="reference">public</span> <span class="type">synchronized</span> <span class="type">ResourceFilter</span>[] <span class="function-name">getFilters</span>(<span class="type">Class</span> <span class="variable-name">cls</span>) {
	<span class="type">ResourceFrame</span> <span class="variable-name">frames</span>[] = collectFrames(cls);
	<span class="keyword">if</span> ( frames != <span class="keyword">null</span> ) {
	    <span class="comment">// FIXME Normally a simple cast should suffice (?)
</span>	    <span class="type">ResourceFilter</span> <span class="variable-name">f</span>[] = <span class="keyword">new</span> <span class="type">ResourceFilter</span>[frames.length];
	    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < frames.length ; i++)
		f[i] = (<span class="type">ResourceFilter</span>) frames[i];
	    <span class="keyword">return</span> f;
	}
	<span class="keyword">return</span> <span class="keyword">null</span>;
    }

}

    </pre>
  </body>
</html>
