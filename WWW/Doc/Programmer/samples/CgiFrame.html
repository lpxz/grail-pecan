<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0//EN"
                      "http://www.w3.org/TR/REC-html40/strict.dtd">
<html>
  <head>
    <title>CgiFrame.java</title>
    <meta name="Author" content="Benoit Mahe">
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <meta name="Generator" content="*emacs: emacs-css">

    <link rel="Stylesheet" media="screen" type="text/css" href="default-html.css">
  </head>
  <body>

    <pre>
<span class="comment">// CgiFrame.java
// $Id: CgiFrame.html,v 1.1 2011/07/26 02:26:47 smhuang Exp $
// (c) COPYRIGHT MIT and INRIA, 1996.
// Please first read the full copyright statement in file COPYRIGHT.html
</span>
<span class="keyword">package</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">jigsaw</span>.<span class="type">frames</span> ;

<span class="keyword">import</span> <span class="reference">java</span>.<span class="reference">io</span>.* ;
<span class="keyword">import</span> <span class="reference">java</span>.<span class="reference">util</span>.*;
<span class="keyword">import</span> <span class="reference">java</span>.<span class="reference">net</span>.*;

<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">resources</span>.*;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">tools</span>.<span class="reference">resources</span>.<span class="type">ProtocolException</span>;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">www</span>.<span class="reference">mime</span>.* ;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">jigsaw</span>.<span class="reference">http</span>.* ;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">www</span>.<span class="reference">http</span>.*;
<span class="keyword">import</span> <span class="reference">org</span>.<span class="reference">w3c</span>.<span class="reference">jigsaw</span>.<span class="reference">auth</span>.<span class="type">AuthFilter</span>;

<span class="comment">/**
 * Parsing the CGI output - The CGIHeaderHolder, to hold CGI headers.
 */</span>
<span class="keyword">class</span> <span class="function-name">CGIHeaderHolder</span> <span class="keyword">implements</span> <span class="type">MimeHeaderHolder</span> {
    <span class="comment">// Status and Location deserve special treatments:
</span>    <span class="type">String</span> <span class="variable-name">status</span>   = <span class="keyword">null</span>;
    <span class="type">String</span> <span class="variable-name">location</span> = <span class="keyword">null</span>;
    <span class="comment">// Anyway, he is going to pay for using CGI
</span>    <span class="type">Hashtable</span> <span class="variable-name">headers</span> = <span class="keyword">null</span>;
    <span class="comment">// The MIME parse we are attached to:
</span>    <span class="type">MimeParser</span> <span class="variable-name">parser</span> = <span class="keyword">null</span>;

    <span class="comment">/**
     * The parsing is now about to start, take any appropriate action.
     * This hook can return a &lt;strong&gt;true&lt;/strong&gt; boolean value to enforce
     * the MIME parser into transparent mode (eg the parser will &lt;em&gt;not&lt;/em&gt;
     * try to parse any headers.
     * &lt;p&gt;This hack is primarily defined for HTTP/0.9 support, it might
     * also be usefull for other hacks.
     * </span><span class="keyword">@param </span><span class="variable-name">parser</span><span class="comment"> The Mime parser.
     * </span><span class="keyword">@return </span><span class="comment">A boolean &lt;strong&gt;true&lt;/strong&gt; if the MimeParser shouldn't
     * continue the parsing, &lt;strong&gt;false&lt;/strong&gt; otherwise.
     */</span>

    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">notifyBeginParsing</span>(<span class="type">MimeParser</span> <span class="variable-name">parser</span>)
	<span class="keyword">throws</span> <span class="type">IOException</span>
    {
	<span class="keyword">return</span> <span class="keyword">false</span>;
    }

    <span class="comment">/**
     * All the headers have been parsed, take any appropriate actions.
     * </span><span class="keyword">@param </span><span class="variable-name">parser</span><span class="comment"> The Mime parser.
     */</span>

    <span class="reference">public</span> <span class="type">void</span> <span class="function-name">notifyEndParsing</span>(<span class="type">MimeParser</span> <span class="variable-name">parser</span>)
	<span class="keyword">throws</span> <span class="type">IOException</span>
    {
	<span class="keyword">return</span> ;
    }

    <span class="comment">/**
     * A new header has been emited by the script.
     * If the script is not an NPH, then it &lt;strong&gt;must&lt;/strong&gt; at least
     * emit one header, so we are safe here, although people may not be safe 
     * against the spec.
     * </span><span class="keyword">@param </span><span class="variable-name">name</span><span class="comment"> The header name.
     * </span><span class="keyword">@param </span><span class="variable-name">buf</span><span class="comment"> The header bytes.
     * </span><span class="keyword">@param </span><span class="variable-name">off</span><span class="comment"> The begining of the value bytes  in above buffer.
     * </span><span class="keyword">@param </span><span class="variable-name">len</span><span class="comment"> The length of the value bytes  in above buffer.
     */</span>

    <span class="reference">public</span> <span class="type">void</span> <span class="function-name">notifyHeader</span>(<span class="type">String</span> <span class="variable-name">name</span>, <span class="type">byte</span> <span class="variable-name">buf</span>[], <span class="type">int</span> <span class="variable-name">off</span>, <span class="type">int</span> <span class="variable-name">len</span>)
	<span class="keyword">throws</span> <span class="type">MimeParserException</span>
    {
	<span class="keyword">if</span> ( name.equalsIgnoreCase("<span class="string">status</span>") ) {
	    status = <span class="keyword">new</span> <span class="type">String</span>(buf, 0, off, len);
	} <span class="keyword">else</span> <span class="keyword">if</span> ( name.equalsIgnoreCase("<span class="string">location</span>") ) {
	    location = <span class="keyword">new</span> <span class="type">String</span>(buf, 0, off, len);
	} <span class="keyword">else</span> {
	    <span class="type">String</span> <span class="variable-name">extraval</span> =  <span class="keyword">new</span> <span class="type">String</span>(buf, 0, off, len);
	    <span class="keyword">if</span> ( headers == <span class="keyword">null</span> ) {
		headers = <span class="keyword">new</span> <span class="type">Hashtable</span>(11);
	    } <span class="keyword">else</span> {
		<span class="type">String</span> <span class="variable-name">val</span> = (<span class="type">String</span>) headers.get(name.toLowerCase());
		<span class="keyword">if</span> ( val != <span class="keyword">null</span> )
		    extraval = val + "<span class="string">,</span>" + extraval;
	    }
	    headers.put(name.toLowerCase(), extraval);
	}
    }

    <span class="comment">/**
     * Get the status emited by the script.
     */</span>
    
    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getStatus</span>() {
	<span class="keyword">return</span> status;
    }

    <span class="comment">/**
     * Get the location header value emited by the script.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getLocation</span>() {
	<span class="keyword">return</span> location;
    }

    <span class="comment">/**
     * Get any header value (except status and location).
     * </span><span class="keyword">@param </span><span class="variable-name">name</span><span class="comment"> The name of the header to fetch.
     * </span><span class="keyword">@return </span><span class="comment">The string value of requested header, or &lt;strong&gt;null&lt;/strong&gt;
     * if header was not defined.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getValue</span>(<span class="type">String</span> <span class="variable-name">name</span>) {
	<span class="keyword">return</span> (headers == <span class="keyword">null</span>) ? <span class="keyword">null</span> : (<span class="type">String</span>) headers.get(name);
    }

    <span class="comment">/**
     * Enumerate the headers defined by the holder.
     * </span><span class="keyword">@return </span><span class="comment">A enumeration of header names, or &lt;strong&gt;null&lt;/strong&gt; if no
     * header is defined.
     */</span>
    
    <span class="reference">public</span> <span class="type">Enumeration</span> <span class="function-name">enumerateHeaders</span>() {
	<span class="keyword">if</span> ( headers == <span class="keyword">null</span> )
	    <span class="keyword">return</span> <span class="keyword">null</span>;
	<span class="keyword">return</span> headers.keys();
    }

    <span class="comment">/**
     * Get the remaining output of the stream.
     * This should be called only once header parsing is done.
     */</span>

    <span class="reference">public</span> <span class="type">InputStream</span> <span class="function-name">getInputStream</span>() {
	<span class="keyword">return</span> parser.getInputStream();
    }

    <span class="function-name">CGIHeaderHolder</span>(<span class="type">MimeParser</span> <span class="variable-name">parser</span>) {
	<span class="reference">this</span>.parser = parser;
    }

}

<span class="comment">/**
 * Parsing the CGI output - Always create a CGIHeaderHolder.
 */</span>

<span class="keyword">class</span> <span class="function-name">CGIHeaderHolderFactory</span> <span class="keyword">implements</span> <span class="type">MimeParserFactory</span> {
    
    <span class="comment">/**
     * Create a new header holder to hold the parser's result.
     * </span><span class="keyword">@param </span><span class="variable-name">parser</span><span class="comment"> The parser that has something to parse.
     * </span><span class="keyword">@return </span><span class="comment">A MimeParserHandler compliant object.
     */</span>

    <span class="reference">public</span> <span class="type">MimeHeaderHolder</span> <span class="function-name">createHeaderHolder</span>(<span class="type">MimeParser</span> <span class="variable-name">parser</span>) {
	<span class="keyword">return</span> <span class="keyword">new</span> <span class="type">CGIHeaderHolder</span>(parser);
    }

    <span class="function-name">CGIHeaderHolderFactory</span>() {
    }

}

<span class="comment">/**
 * A simple process feeder class.
 */</span>

<span class="keyword">class</span> <span class="function-name">ProcessFeeder</span> <span class="keyword">extends</span> <span class="type">Thread</span> {
    <span class="type">Process</span>      <span class="variable-name">proc</span>    = <span class="keyword">null</span> ;
    <span class="type">OutputStream</span> <span class="variable-name">out</span>     = <span class="keyword">null</span> ;
    <span class="type">InputStream</span>  <span class="variable-name">in</span>      = <span class="keyword">null</span> ;
    <span class="type">int</span>          <span class="variable-name">count</span> = -1 ;

    <span class="reference">public</span> <span class="type">void</span> <span class="function-name">run</span> () {
	<span class="keyword">try</span> {
	    <span class="type">byte</span> <span class="variable-name">buffer</span>[] = <span class="keyword">new</span> <span class="type">byte</span>[4096] ;
	    <span class="type">int</span>  <span class="variable-name">got</span>      = -1 ;
	    
	    <span class="comment">// Send the data to the target process:
</span>	    <span class="keyword">if</span> ( count >= 0 ) {
		<span class="keyword">while</span> ( (count > 0) && ((got = in.read(buffer)) > 0) ) {
		    out.write (buffer, 0, got) ;
		    count -= got ;
		}
	    } <span class="keyword">else</span> {
		<span class="keyword">while</span> ( (got = in.read(buffer)) > 0 ) {
		    out.write (buffer, 0, got) ;
		}
	    }
	} <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">e</span>) {
	    System.out.println ("<span class="string">ProcessFeeder: caught exception !</span>") ;
	    e.printStackTrace() ;
	} <span class="keyword">finally</span> {
	    <span class="comment">// Clean up the process:
</span>	    <span class="keyword">try</span> { out.flush() ; } <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {}
	    <span class="keyword">try</span> { out.close() ; } <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {}
	    <span class="keyword">try</span> { proc.waitFor() ; } <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">ex</span>) {}
	}
    }
	
    <span class="function-name">ProcessFeeder</span> (<span class="type">Process</span> <span class="variable-name">proc</span>, <span class="type">InputStream</span> <span class="variable-name">in</span>) {
	<span class="reference">this</span> (proc, in, -1) ;
    }
	
    <span class="function-name">ProcessFeeder</span> (<span class="type">Process</span> <span class="variable-name">proc</span>, <span class="type">InputStream</span> <span class="variable-name">in</span>, <span class="type">int</span> <span class="variable-name">count</span>) {
	<span class="reference">this</span>.proc   = proc ;
	<span class="reference">this</span>.out    = proc.getOutputStream() ;
	<span class="reference">this</span>.in     = in ;
	<span class="reference">this</span>.count  = count ;
    }
}

<span class="comment">/**
 * Handle CGI scripts.
 */</span>
<span class="reference">public</span> <span class="keyword">class</span> <span class="function-name">CgiFrame</span> <span class="keyword">extends</span> <span class="type">HTTPFrame</span> {

    <span class="string">private</span> <span class="type">final</span> <span class="type">static</span> 
	<span class="type">String</span> <span class="variable-name">STATE_EXTRA_PATH</span> = "<span class="doc-string">org.w3c.jigsaw.frames.CgiFrame.extraPath</span>";

    <span class="comment">/**
     * Attribute index - The interpreter to use, if any.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_INTERPRETER</span> = -1;
    <span class="comment">/**
     * Attribute index - The array of string that makes the command to run.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_COMMAND</span> = -1 ;
    <span class="comment">/**
     * Attribute index - Does the script takes care of its headers ?
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_NOHEADER</span> = -1 ;
    <span class="comment">/**
     * Attribute index - Does the script generates the form on GET ?
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_GENERATES_FORM</span> = -1 ;
    <span class="comment">/**
     * Attribute index - Do DNS, to fill in REMOTE_HOST env var.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_REMOTE_HOST</span> = -1;
    <span class="comment">/**
     * Attribute index - Turn the script in debug mode.
     */</span>
    <span class="preprocessor">protected</span> <span class="type">static</span> <span class="type">int</span> <span class="variable-name">ATTR_CGI_DEBUG</span> = -1;

    <span class="type">static</span> {
	<span class="type">Attribute</span> <span class="variable-name">a</span>   = <span class="keyword">null</span> ;
	<span class="type">Class</span>     <span class="variable-name">cls</span> = <span class="keyword">null</span> ;
	<span class="keyword">try</span> {
	    cls = Class.forName("<span class="string">org.w3c.jigsaw.frames.CgiFrame</span>") ;
	} <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">ex</span>) {
	    ex.printStackTrace() ;
	    System.exit(1) ;
	}
	<span class="comment">// The interpreter attribute:
</span>	a = <span class="keyword">new</span> <span class="type">StringAttribute</span>("<span class="string">interpreter</span>"
				, <span class="keyword">null</span>
				, Attribute.EDITABLE);
	ATTR_INTERPRETER = AttributeRegistry.registerAttribute(cls, a);
	<span class="comment">// The command attribute:
</span>	a = <span class="keyword">new</span> <span class="type">StringArrayAttribute</span>("<span class="string">command</span>"
				     , <span class="keyword">null</span>
				     , Attribute.MANDATORY|Attribute.EDITABLE);
	ATTR_COMMAND = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// The noheader attribute:
</span>	a = <span class="keyword">new</span> <span class="type">BooleanAttribute</span>("<span class="string">noheader</span>"
				 , <span class="reference">Boolean</span>.<span class="type">FALSE</span>
				 , Attribute.EDITABLE) ;
	ATTR_NOHEADER = AttributeRegistry.registerAttribute(cls, a) ;
	<span class="comment">// The generates form attribute
</span>	a = <span class="keyword">new</span> <span class="type">BooleanAttribute</span>("<span class="string">generates-form</span>"
				 , <span class="reference">Boolean</span>.<span class="type">TRUE</span>
				 , Attribute.EDITABLE) ;
	ATTR_GENERATES_FORM = AttributeRegistry.registerAttribute(cls, a);
	<span class="comment">// Registerr the DODNS attribute.
</span>	a = <span class="keyword">new</span> <span class="type">BooleanAttribute</span>("<span class="string">remote-host</span>"
				 , <span class="keyword">null</span>
				 , Attribute.EDITABLE);
	ATTR_REMOTE_HOST = AttributeRegistry.registerAttribute(cls, a);
	<span class="comment">// Register the debug mode flag:
</span>	a = <span class="keyword">new</span> <span class="type">BooleanAttribute</span>("<span class="string">cgi-debug</span>"
				 , <span class="reference">Boolean</span>.<span class="type">FALSE</span>
				 , Attribute.EDITABLE);
	ATTR_CGI_DEBUG = AttributeRegistry.registerAttribute(cls, a);
    }

    <span class="comment">/**
     * Get the interpreter to use to execute the script.
     * This is most usefull for operating systems that don't have a
     * &lt;code&gt;!#&lt;/code&gt; convention ala UNIX.
     * </span><span class="keyword">@return </span><span class="comment">The interpreter to run the script.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getInterpreter</span>() {
	<span class="keyword">return</span> getString(ATTR_INTERPRETER, <span class="keyword">null</span>);
    }

    <span class="comment">/**
     * Get the command string array.
     */</span>

    <span class="reference">public</span> <span class="type">String</span>[] <span class="function-name">getCommand</span>() {
	<span class="keyword">return</span> (<span class="type">String</span>[]) getValue(ATTR_COMMAND, <span class="keyword">null</span>) ;
    }

    <span class="comment">/**
     * Get the noheader flag.
     * </span><span class="keyword">@return </span><span class="comment">The boolean value of the noheader flag.
     */</span>

    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">checkNoheaderFlag</span>() {
	<span class="keyword">return</span> getBoolean(ATTR_NOHEADER, <span class="keyword">false</span>) ;
    }

    <span class="comment">/**
     * Get the generates form flag.
     * </span><span class="keyword">@return </span><span class="comment">The boolean value of the generates form flag.
     */</span>

    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">checkGeneratesFormFlag</span>() {
	<span class="keyword">return</span> getBoolean(ATTR_GENERATES_FORM, <span class="keyword">true</span>) ;
    }

    <span class="comment">/**
     * Get the remote host attribute value.
     * If turned on, this flag will enable the REMOTE_HOST env var computation.
     * </span><span class="keyword">@return </span><span class="comment">A boolean.
     */</span>

    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">checkRemoteHost</span>() {
	<span class="keyword">return</span> getBoolean(ATTR_REMOTE_HOST, <span class="keyword">false</span>);
    }

    <span class="comment">/**
     * Get the CGI debug flag.
     * </span><span class="keyword">@return </span><span class="comment">The boolean value of the CGI debug flag.
     */</span>

    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">checkCgiDebug</span>() {
	<span class="keyword">return</span> getBoolean(ATTR_CGI_DEBUG, <span class="keyword">false</span>);
    }

    <span class="comment">/**
     * Turn the given header name into it's env var canonical name.
     * This guy is crazy enough to run CGI scripts, he can pay for that 
     * overhead.
     * </span><span class="keyword">@param </span><span class="variable-name">name</span><span class="comment"> The header name.
     * </span><span class="keyword">@return </span><span class="comment">A String giving the official env variable name for that header.
     */</span>

    <span class="reference">public</span> <span class="type">String</span> <span class="function-name">getEnvName</span>(<span class="type">String</span> <span class="variable-name">name</span>) {
	<span class="type">int</span>          <span class="variable-name">sl</span> = name.length();
	<span class="type">StringBuffer</span> <span class="variable-name">sb</span> = <span class="keyword">new</span> <span class="type">StringBuffer</span>(5+sl);
	sb.append("<span class="string">HTTP_</span>");
	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable-name">i</span> = 0 ; i < sl ; i++) {
	    <span class="type">char</span> <span class="variable-name">ch</span> = name.charAt(i);
	    sb.append((ch == '<span class="string">-</span>') ? '<span class="string">_</span>' : Character.toUpperCase(ch));
	}
	<span class="keyword">return</span> sb.toString();
    }

    <span class="comment">/**
     * Handle the CGI script output.
     * This methods handles the CGI script output. Depending on the
     * value of the &lt;strong&gt;noheader&lt;/strong&gt; attribute it either:
     * &lt;ul&gt;
     * &lt;li&gt;Sends back the script output directly,&lt;/li&gt;
     * &lt;li&gt;Parses the script output, looking for a status header or a 
     * location header, or a content-length header, or any combination
     * of those three.
     * &lt;/ul&gt;
     * </span><span class="keyword">@param </span><span class="variable-name">process</span><span class="comment"> The underlying CGI process.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The processed request.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> If an HTTP error should be sent back 
     * to the client.
     */</span>

    <span class="preprocessor">protected</span> <span class="type">Reply</span> <span class="function-name">handleCGIOutput</span> (<span class="type">Process</span> <span class="variable-name">process</span>, <span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>
    {
	<span class="comment">// No header script don't deserve attention:
</span>	<span class="keyword">if</span> ( checkNoheaderFlag() ) {
	    <span class="type">Reply</span> <span class="variable-name">reply</span> = request.makeReply(HTTP.NOHEADER) ;
	    reply.setStream (process.getInputStream()) ;
	    <span class="keyword">return</span> reply ;
	}
	<span class="comment">// Check for debugging mode:
</span>	<span class="keyword">if</span> ( checkCgiDebug() ) {
	    <span class="type">Reply</span> <span class="variable-name">reply</span> = request.makeReply(HTTP.OK);
	    reply.setContentType(MimeType.TEXT_PLAIN);
	    reply.setStream(process.getInputStream());
	    <span class="keyword">return</span> reply;
	}
	<span class="comment">// We MUST parse at least one header:
</span>	<span class="type">MimeParser</span> <span class="variable-name">p</span> = <span class="keyword">new</span> <span class="type">MimeParser</span>(process.getInputStream(),
				      <span class="keyword">new</span> <span class="type">CGIHeaderHolderFactory</span>());
	<span class="type">Reply</span>           <span class="variable-name">reply</span>  = <span class="keyword">null</span> ;
	<span class="keyword">try</span> {
	    <span class="type">CGIHeaderHolder</span> <span class="variable-name">h</span> = (<span class="type">CGIHeaderHolder</span>) p.parse();
	    <span class="comment">// Check for a status code:
</span>	    <span class="type">String</span> <span class="variable-name">svalue</span>   = h.getStatus();
	    <span class="type">String</span> <span class="variable-name">location</span> = h.getLocation();
	    <span class="keyword">if</span> ( svalue != <span class="keyword">null</span> ) {
		<span class="type">int</span> <span class="variable-name">status</span> = -1;
		<span class="keyword">try</span> {
		    status = Integer.parseInt(svalue);
		} <span class="keyword">catch</span> (<span class="type">Exception</span> <span class="variable-name">ex</span>) {
		    <span class="comment">// This script has emited an invalid status line:
</span>		    <span class="type">String</span> <span class="variable-name">msg</span> = ("<span class="string">Emited an invalid status line [</span>"+
				  svalue + "<span class="string">].</span>");
		    getServer().errlog(<span class="reference">this</span>, msg);
		    <span class="comment">// Throw an HTTPException:
</span>		    reply = request.makeReply(HTTP.INTERNAL_SERVER_ERROR);
		    reply.setContent("<span class="string">CGI script emited invalid status.</span>");
		    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span>(reply);
		}
		reply = request.makeReply(status);
	    } <span class="keyword">else</span> {
		<span class="comment">// No status code available, any location header ?
</span>		reply = request.makeReply((location == <span class="keyword">null</span>)
					  ? <span class="reference">HTTP</span>.<span class="type">OK</span>
					  : HTTP.FOUND);
	    }
	    <span class="comment">// Set up the location header if needed:
</span>	    <span class="keyword">if</span> ( location != <span class="keyword">null</span> ) {
		<span class="keyword">try</span> {
		    reply.setLocation(<span class="keyword">new</span> <span class="type">URL</span>(getURL(request), location));
		} <span class="keyword">catch</span> (<span class="type">MalformedURLException</span> <span class="variable-name">ex</span>) {
		    <span class="comment">// This should really not happen:
</span>		    getServer().errlog(<span class="reference">this</span>, "<span class="string">unable to create location url </span>"+
				       location+
				       "<span class="string"> in base </span>"+getURL(request));
		}
	    }
	    <span class="comment">// And then, the remaining headers:
</span>	    <span class="type">Enumeration</span> <span class="variable-name">e</span> = h.enumerateHeaders();
	    <span class="keyword">if</span> ( e != <span class="keyword">null</span> ) {
		<span class="keyword">while</span> ( e.hasMoreElements() ) {
		    <span class="type">String</span> <span class="variable-name">hname</span> = (<span class="type">String</span>) e.nextElement();
		    reply.setValue(hname, (<span class="type">String</span>) h.getValue(hname));
		}
	    }
	    reply.setStream(p.getInputStream()) ;
	} <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {
	    ex.printStackTrace();
	} <span class="keyword">catch</span> (<span class="type">MimeParserException</span> <span class="variable-name">ex</span>) {
	    <span class="comment">// This script has generated invalid output:
</span>	    <span class="type">String</span> <span class="variable-name">msg</span> = (getURL(request)
			  +"<span class="string">: emited invalid output [</span>"+
			  ex.getMessage() +"<span class="string">]</span>");
	    getServer().errlog(<span class="reference">this</span>, msg);
	    <span class="comment">// Throw an HTTPException:
</span>	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.INTERNAL_SERVER_ERROR) ;
	    error.setContent("<span class="string">CGI error: unable to parse script headers.</span>") ;
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	}
	<span class="keyword">return</span> reply ;
    }

    <span class="comment">/**
     * Add an enviornment binding to the given vector.
     * </span><span class="keyword">@param </span><span class="variable-name">name</span><span class="comment"> The name of the enviornment variable.
     * </span><span class="keyword">@param </span><span class="variable-name">val</span><span class="comment"> Its value.
     * </span><span class="keyword">@param </span><span class="variable-name">into</span><span class="comment"> The vector to which accumulate bindings.
     */</span>

    <span class="string">private</span> <span class="type">void</span> <span class="function-name">addEnv</span> (<span class="type">String</span> <span class="variable-name">name</span>, <span class="type">String</span> <span class="variable-name">val</span>, <span class="type">Vector</span> <span class="variable-name">into</span>) {
	into.addElement (name+"<span class="string">=</span>"+val) ;
    }
    
    <span class="comment">/**
     * Prepare the command to run for this CGI script, and run it.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@return </span><span class="comment">The running CGI process object.
     * </span><span class="keyword">@exception </span><span class="type">HTTPException</span><span class="comment"> If we weren't able to build the command or
     *    the environment.
     */</span>

    <span class="preprocessor">protected</span> <span class="type">Process</span> <span class="function-name">makeCgiCommand</span> (<span class="type">Request</span> <span class="variable-name">request</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">IOException</span> 
    {
	<span class="comment">// Check the command attribute first:
</span>	<span class="type">String</span>      <span class="variable-name">query</span>     = <span class="keyword">null</span>;
	<span class="type">String</span>      <span class="variable-name">command</span>[] = getCommand() ;
	<span class="keyword">if</span> ( command == <span class="keyword">null</span> ) {
	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.INTERNAL_SERVER_ERROR) ;
	    error.setContent("<span class="string">CgiResource mis-configured: it doesn't have a </span>"
			     + "<span class="string"> command attribute</span>");
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span>(error);
	}
	<span class="comment">// Ok:
</span>	<span class="type">Vector</span>      <span class="variable-name">env</span>       = <span class="keyword">new</span> <span class="type">Vector</span>(32) ;
	httpd       server    = request.getClient().getServer() ;
	<span class="type">InetAddress</span> <span class="variable-name">sadr</span>      = server.getInetAddress() ;
	<span class="comment">// Specified environment variables:
</span>	<span class="comment">// We do not handle the following variables:
</span>	<span class="comment">// - PATH_TRANSLATED: I don't understand it
</span>	<span class="comment">// - REMOTE_IDENT: would require usage of IDENT protocol.
</span>	<span class="comment">// Authentification type, if any:
</span>	<span class="type">String</span> <span class="variable-name">svalue</span> = (<span class="type">String</span>) request.getState(AuthFilter.STATE_AUTHTYPE);
	<span class="keyword">if</span> ( svalue != <span class="keyword">null</span> )
	    addEnv("<span class="string">AUTH_TYPE</span>", svalue, env);
	<span class="comment">// Content length, if available:
</span>	svalue = request.getValue("<span class="string">content-length</span>");
	<span class="keyword">if</span> ( svalue != <span class="keyword">null</span> )
	    addEnv("<span class="string">CONTENT_LENGTH</span>", svalue, env);
	<span class="comment">// Content type, if available:
</span>	svalue = request.getValue("<span class="string">content-type</span>");
	<span class="keyword">if</span> ( svalue != <span class="keyword">null</span> )
	    addEnv("<span class="string">CONTENT_TYPE</span>", svalue, env);
	<span class="comment">// The gateway interface, hopefully 1.1 !
</span>	addEnv ("<span class="string">GATEWAY_INTERFACE</span>", "<span class="string">CGI/1.1</span>", env) ;
	<span class="comment">// The PATH_INFO, which I am afraid I still don't understand:
</span>	svalue = (<span class="type">String</span>) request.getState(STATE_EXTRA_PATH);
	<span class="keyword">if</span> ( svalue == <span class="keyword">null</span> )
	    addEnv ("<span class="string">PATH_INFO</span>", "<span class="string">/</span>", env) ; 
	<span class="keyword">else</span>
	    addEnv ("<span class="string">PATH_INFO</span>", svalue, env) ; 
	<span class="comment">// The query string:
</span>	query = request.getQueryString();
	<span class="keyword">if</span> ( query != <span class="keyword">null</span> ) 
	    addEnv("<span class="string">QUERY_STRING</span>", query, env) ;
	<span class="comment">// The remote client IP address:
</span>	svalue = request.getClient().getInetAddress().toString();
	addEnv ("<span class="string">REMOTE_ADDR</span>", svalue, env);
	<span class="comment">// Authentified user:
</span>	svalue = (<span class="type">String</span>) request.getState(AuthFilter.STATE_AUTHUSER);
	<span class="keyword">if</span> ( svalue != <span class="keyword">null</span> )
	    addEnv("<span class="string">REMOTE_USER</span>", svalue, env);
	<span class="comment">// Remote host name, if allowed:
</span>	<span class="keyword">if</span> ( checkRemoteHost() ) {
	    <span class="type">String</span> <span class="variable-name">host</span> = request.getClient().getInetAddress().getHostName();
	    addEnv("<span class="string">REMOTE_HOST</span>", host, env);
	}
	<span class="comment">// The request method:
</span>	addEnv ("<span class="string">REQUEST_METHOD</span>", request.getMethod(), env) ;
	<span class="comment">// The script name :
</span>	addEnv("<span class="string">SCRIPT_NAME</span>", getURLPath(), env);
	<span class="comment">// Server name:
</span>	addEnv ("<span class="string">SERVER_NAME</span>", getServer().getHost(), env) ;
	<span class="comment">// Server port:
</span>	svalue = Integer.toString(getServer().getLocalPort());
	addEnv ("<span class="string">SERVER_PORT</span>", svalue, env);
	<span class="comment">// Server protocol:
</span>	addEnv ("<span class="string">SERVER_PROTOCOL</span>", request.getVersion(), env) ;
	<span class="comment">// Server software:
</span>	addEnv ("<span class="string">SERVER_SOFTWARE</span>", server.getSoftware(), env) ;
	<span class="comment">// All other request fields, yeah, let's lose even more time:
</span>	<span class="type">Enumeration</span> <span class="variable-name">e</span> = request.enumerateHeaderDescriptions(<span class="keyword">false</span>);
	<span class="keyword">while</span> ( e.hasMoreElements() ) {
	    <span class="type">HeaderDescription</span> <span class="variable-name">d</span> = (<span class="type">HeaderDescription</span>) e.nextElement();
	    addEnv(getEnvName(d.getName())
		   , request.getHeaderValue(d).toString()
		   , env);
	}
	<span class="comment">// Command line:
</span>	<span class="keyword">if</span> ( query != <span class="keyword">null</span> ) {
	    <span class="type">String</span> <span class="variable-name">querycmd</span>[] = <span class="keyword">new</span> <span class="type">String</span>[command.length+1] ;
	    System.arraycopy(command, 0, querycmd, 0, command.length) ;
	    querycmd[command.length] = query ;
	    command = querycmd ;
	}
	<span class="type">String</span> <span class="variable-name">aenv</span>[] = <span class="keyword">new</span> <span class="type">String</span>[env.size()] ;
	env.copyInto (aenv) ;
	<span class="comment">// Run the process:
</span>	<span class="keyword">if</span> ( getInterpreter() != <span class="keyword">null</span> ) {
	    <span class="type">String</span> <span class="variable-name">run</span>[] = <span class="keyword">new</span> <span class="type">String</span>[command.length+1];
	    run[0] = getInterpreter();
	    System.arraycopy(command, 0, run, 1, command.length);
	    <span class="keyword">return</span> Runtime.getRuntime().exec (run, aenv) ;
	} <span class="keyword">else</span> {
	    <span class="keyword">return</span> Runtime.getRuntime().exec (command, aenv) ;
	}
    }

    <span class="comment">/**
     * Lookup sub-resources.
     * Accumulate the remaning path in some special state of the request.
     * &lt;p&gt;This allows us to implement the &lt;code&gt;PATH_INFO&lt;/code&gt; 
     * CGI variable properly.
     * </span><span class="keyword">@param </span><span class="variable-name">ls</span><span class="comment"> Current lookup state.
     * </span><span class="keyword">@param </span><span class="variable-name">lr</span><span class="comment"> Lookup result under construction.
     * </span><span class="keyword">@return </span><span class="comment">A boolean &lt;strong&gt;true&lt;/strong&gt; if lookup should continue,
     * &lt;strong&gt;false&lt;/strong&gt; otherwise.
     */</span>

    <span class="reference">public</span> <span class="type">boolean</span> <span class="function-name">lookup</span>(<span class="type">LookupState</span> <span class="variable-name">ls</span>, <span class="type">LookupResult</span> <span class="variable-name">lr</span>) 
	<span class="keyword">throws</span> <span class="type">ProtocolException</span> 
    {
	<span class="comment">// Get the extra path information:
</span>	<span class="type">String</span> <span class="variable-name">extraPath</span> = ls.getRemainingPath(<span class="keyword">true</span>);
	<span class="keyword">if</span> ((extraPath == <span class="keyword">null</span>) || extraPath.equals(""))
	    extraPath = "<span class="string">/</span>";
	<span class="comment">// Keep this path info into the request, if possible:
</span>	<span class="type">Request</span> <span class="variable-name">request</span> = (<span class="type">Request</span>) ls.getRequest();
	<span class="keyword">if</span> ( request != <span class="keyword">null</span> )
	    request.setState(STATE_EXTRA_PATH, extraPath);
	lr.setTarget(getResource().getResourceReference());
	<span class="keyword">return</span> <span class="reference">super</span>.lookup(ls, lr);
    }
  
    <span class="comment">/** 
     * GET method implementation.
     * this method is splitted into two cases:
     * &lt;p&gt;If the resource is able to generates its form, than run the script
     * to emit the form. Otherwsie, use our super class (FileResource) ability
     * to send the file that contains the form.
     * &lt;p&gt;Note that there is no need to feed the underlying process with
     * data in the GET case.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to handle.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> If processing the request failed.
     */</span>
    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">get</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
   {
       <span class="keyword">if</span> ( ! checkGeneratesFormFlag() )
	   <span class="keyword">return</span> <span class="reference">super</span>.get (request) ;
       <span class="type">Process</span>       <span class="variable-name">process</span> = <span class="keyword">null</span> ;
       <span class="keyword">try</span> {
	   process = makeCgiCommand (request) ;
       } <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">e</span>) {
	   <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.NOT_FOUND) ;
	   error.setContent("<span class="string">The resource's script wasn't found.</span>") ;
	   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
       }
       <span class="keyword">return</span> handleCGIOutput (process, request) ;
   }


    <span class="comment">/**
     * Handle the POST method according to CGI/1.1 specification.
     * The request body is sent back to the launched CGI script, as is, and
     * the script output is handled by the handleCGIOutput method.
     * </span><span class="keyword">@param </span><span class="variable-name">request</span><span class="comment"> The request to process.
     * </span><span class="keyword">@exception </span><span class="type">ProtocolException</span><span class="comment"> If the processing failed.
     */</span>
    <span class="reference">public</span> <span class="type">Reply</span> <span class="function-name">post</span>(<span class="type">Request</span> <span class="variable-name">request</span>)
	<span class="keyword">throws</span> <span class="type">ProtocolException</span>, <span class="type">NotAProtocolException</span>
    {
	<span class="type">Process</span>       <span class="variable-name">process</span> = <span class="keyword">null</span> ;
	<span class="comment">// Launch the CGI process:
</span>	<span class="keyword">try</span> {
	    process = makeCgiCommand(request) ;
	} <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {
	    <span class="comment">// The process wasn't executable, emit a errlog message:
</span>	    <span class="type">String</span> <span class="variable-name">msg</span> = ("<span class="string">The process </span>"+
			  getCommand()[0] +"<span class="string"> couldn't be executed [</span>"+
			  ex.getMessage() + "<span class="string">]</span>");
	    getServer().errlog(<span class="reference">this</span>, msg);
	    <span class="comment">// Throw an internal server error:
</span>	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.INTERNAL_SERVER_ERROR) ;
	    error.setContent("<span class="string">CGI script is misconfigured.</span>");
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span> (error) ;
	}
	<span class="comment">// Now feed the process:
</span>	<span class="keyword">try</span> {
	    <span class="comment">// Send the 100 status code:
</span>	    <span class="type">Client</span> <span class="variable-name">client</span> = request.getClient();
	    <span class="keyword">if</span> ( client != <span class="keyword">null</span> ) 
		client.sendContinue();
	    <span class="type">InputStream</span> <span class="variable-name">in</span> = request.getInputStream();
	    <span class="keyword">if</span> ( in == <span class="keyword">null</span> ) {
		<span class="comment">// There was no input to that CCI, close process stream
</span>		process.getOutputStream().close();
	    } <span class="keyword">else</span> {
		<span class="comment">// Some input to feed the process with:
</span>		(<span class="keyword">new</span> <span class="type">ProcessFeeder</span>(process, in)).start();
	    }
	} <span class="keyword">catch</span> (<span class="type">IOException</span> <span class="variable-name">ex</span>) {
	    <span class="comment">// This is most probably a bad request:
</span>	    <span class="type">Reply</span> <span class="variable-name">error</span> = request.makeReply(HTTP.BAD_REQUEST);
	    error.setContent("<span class="string">The request didn't have a valid input.</span>");
	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">HTTPException</span>(error);
	}
	<span class="keyword">return</span> handleCGIOutput(process, request);
    }
    
    <span class="comment">/**
     * At register time, if no command, use a suitable default.
     * THis method will set the command to the identifier, if it is not
     * provided.
     * </span><span class="keyword">@param </span><span class="variable-name">values</span><span class="comment"> Default attribute values.
     */</span>
    
    <span class="reference">public</span> <span class="type">void</span> <span class="function-name">registerResource</span>(<span class="type">FramedResource</span> <span class="variable-name">resource</span>) {
	<span class="reference">super</span>.registerResource(resource);
	<span class="comment">//if no command is specified look for a file resource attached
</span>	<span class="comment">//and get its File absolute path if available.
</span>	<span class="keyword">if</span> (getCommand() == <span class="keyword">null</span>) {
	    <span class="keyword">if</span> (getFileResource() != <span class="keyword">null</span>) {
		<span class="keyword">if</span> (getFileResource().getFile() != <span class="keyword">null</span>) {
		    <span class="type">String</span> <span class="variable-name">cmd</span>[] = <span class="keyword">new</span> <span class="type">String</span>[1];
		    cmd[0] = getFileResource().getFile().getAbsolutePath();
		    setValue(ATTR_COMMAND, cmd);
		}
	    }
	}
    }
}

    </pre>
  </body>
</html>
